<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Tricks | Maestro IA & Puzzles - Optimizado</title>

    <!-- LIBRER√çAS (CDN) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>

    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#22c55e">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- iOS TOUCH FIX -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">

    <!-- PRELOAD CR√çTICO PARA STOCKFISH -->
    <link rel="preload" href="stockfish.js" as="script">

    <style>
        /* OPTIMIZACI√ìN: A√±adir animaci√≥n de pulse para thinking */
        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.5;
            }
        }

        .ai-thinking {
            animation: pulse 1.5s ease-in-out infinite;
        }

        /* iOS Safari fix para viewport height */
        @supports (-webkit-touch-callout: none) {
            body {
                min-height: -webkit-fill-available;
            }
        }

        /* Prevenir zoom accidental en iOS */
        input,
        select,
        textarea {
            font-size: 16px !important;
        }
    </style>
</head>

<body>
    <!-- INDICADOR DE VERSI√ìN (DEBUGGING) -->
    <div style="position:fixed; bottom:5px; right:5px; font-size:0.6rem; color:#666; z-index:999999; opacity:0.5;">
        v2.5-OPT
    </div>

    <div id="toast-container"></div>
    <div class="app-header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="hamburger-menu" style="cursor:pointer; font-size:1.4rem; color:var(--accent);">‚ò∞</div>
            <button id="btn-mobile-menu-back" style="display:none;">‚¨ÖÔ∏è</button>
            <div class="logo-inline">
                <img src="logo.jpg" alt="Logo" style="height:32px; width:32px; object-fit:contain; border-radius:4px;">
                <h1>CHESS <span style="color:var(--accent)">TRICKS</span></h1>
            </div>
        </div>
        <div id="header-user-info"
            style="display:flex; align-items:center; gap:6px; overflow-x:auto; max-width:60vw; scrollbar-width:none;">
            <div id="header-elo1" title="Bullet (1m)" onclick="showSubMenu('lobby')"
                style="background:rgba(239, 68, 68, 0.1); border:1px solid #ef4444; color:#ef4444; padding:2px 6px; border-radius:4px; font-size:0.6rem; font-weight:700; flex-shrink:0; cursor:pointer;">
                1m: 500</div>
            <div id="header-elo3" title="Blitz (3m)" onclick="showSubMenu('lobby')"
                style="background:rgba(245, 158, 11, 0.1); border:1px solid #f59e0b; color:#f59e0b; padding:2px 6px; border-radius:4px; font-size:0.6rem; font-weight:700; flex-shrink:0; cursor:pointer;">
                3m: 500</div>
            <div id="header-elo10" title="Rapid (10-30m)" onclick="showSubMenu('lobby')"
                style="background:rgba(34, 197, 94, 0.1); border:1px solid var(--accent); color:var(--accent); padding:2px 6px; border-radius:4px; font-size:0.6rem; font-weight:700; flex-shrink:0; cursor:pointer;">
                R: 500</div>
            <div id="header-eloDaily" title="Daily (24h)" onclick="showSubMenu('lobby')"
                style="background:rgba(167, 139, 250, 0.1); border:1px solid #a78bfa; color:#a78bfa; padding:2px 6px; border-radius:4px; font-size:0.6rem; font-weight:700; flex-shrink:0; cursor:pointer;">
                24h: 500</div>
            <div id="header-elo-puz" title="Puzzles"
                style="background:rgba(59, 130, 246, 0.1); border:1px solid #3b82f6; color:#3b82f6; padding:2px 6px; border-radius:4px; font-size:0.6rem; font-weight:700; flex-shrink:0;">
                üß©: 500</div>
            <div id="btn-auth-trigger"
                style="cursor:pointer; font-size:0.8rem; color:var(--text-muted); flex-shrink:0; margin-left:5px;">üë§
            </div>
        </div>
    </div>

    <!-- MODALES AUTH -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-card">
            <h3 id="auth-title">INICIAR SESI√ìN</h3>
            <div class="input-group">
                <label>USUARIO</label>
                <input type="text" id="auth-user" placeholder="Tu nombre...">
            </div>
            <div class="input-group" id="reg-group" style="display:none;">
                <label>EMAIL</label>
                <input type="email" id="auth-email" placeholder="correo@ejemplo.com">
            </div>
            <div class="input-group">
                <label>CONTRASE√ëA</label>
                <div style="position:relative">
                    <input type="password" id="auth-pass" placeholder="******" autocomplete="current-password"
                        style="padding-right:35px;">
                    <span id="btn-show-pass"
                        style="position:absolute; right:10px; top:50%; transform:translateY(-50%); cursor:pointer;">üëÅÔ∏è</span>
                </div>
            </div>
            <button class="btn-primary" id="btn-auth-submit">ENTRAR</button>
            <p id="auth-privacy" style="font-size:0.6rem; color:var(--text-muted); margin-top:10px; text-align:center;">
                üîí Tus datos se cifran y guardan de forma segura conforme a la normativa de privacidad.
            </p>
            <p id="auth-switch"
                style="font-size:0.7rem; text-align:center; margin-top:15px; cursor:pointer; color:var(--text-muted);">
                ¬øNo tienes cuenta? <span style="color:var(--accent)">Reg√≠strate</span></p>
            <button class="btn-tool" id="btn-auth-close" style="width:100%; margin-top:10px;">INICIAR SESI√ìN
                LUEGO</button>
            <button class="btn-tool" onclick="$('#auth-modal').hide();"
                style="width:100%; margin-top:10px; border-color:transparent; background:none; font-size:0.75rem; color:var(--text-muted);">Continuar
                como invitado</button>
            <div id="auth-delete-area" style="margin-top:20px; text-align:center; display:none;">
                <button onclick="confirmDeleteAccount()"
                    style="background:none; border:none; color:#ef4444; font-size:0.6rem; text-decoration:underline; cursor:pointer; opacity:0.6;">Darse
                    de baja (Cerrar cuenta permanentemente)</button>
            </div>
        </div>
    </div>

    <div id="side-drawer-overlay"></div>
    <div id="side-drawer">
        <div class="drawer-section" style="margin-bottom:20px;">
            <label class="label-tiny" id="lbl-user">üë§ USUARIO</label>
            <div id="drawer-user-card"
                style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; display:flex; flex-direction:column; gap:8px;">
                <div id="drawer-user-name" style="font-weight:700; color:var(--accent);">Invitado</div>
                <div id="drawer-user-elo" style="font-size:0.7rem; color:var(--text-muted);">ELO: 500</div>
                <button class="btn-primary" id="btn-auth-drawer" style="padding:8px; font-size:0.65rem;">ACCEDER /
                    REGISTRO</button>
                <button class="btn-danger" id="btn-logout-drawer"
                    style="padding:8px; font-size:0.65rem; display:none;">CERRAR SESI√ìN</button>
            </div>
        </div>

        <!-- SECCI√ìN DE NAVEGACI√ìN EXTRA -->
        <div class="drawer-section" id="drawer-nav-extra"
            style="margin-bottom:20px; border-top:1px solid rgba(255,255,255,0.05); padding-top:15px;">
            <div class="btn-menu" style="padding:10px; font-size:0.8rem;" onclick="setTab('tab-history')">
                <span>üìú</span><span>Historial de Partidas</span>
            </div>
            <div class="btn-menu" style="padding:10px; font-size:0.8rem;" onclick="setTab('tab-ranking')">
                <span>üèÜ</span><span>Ranking Global</span>
            </div>
            <div class="btn-menu" style="padding:10px; font-size:0.8rem;"
                onclick="alert('Estad√≠sticas detalladas pr√≥ximamente...')"><span>üìä</span><span>Estad√≠sticas</span>
            </div>
        </div>

        <div class="drawer-section" style="margin-bottom:20px;">
            <label class="label-tiny" id="lbl-appearance">üé® APARIENCIA</label>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.6rem; color:var(--text-muted);" id="lbl-board">Tablero</label>
                <select class="btn-control" id="board-theme-sel">
                    <option value="classic">Cl√°sico (Azul)</option>
                    <option value="wood">Madera</option>
                    <option value="neon">Neon Dark</option>
                    <option value="forest">Bosque</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.6rem; color:var(--text-muted);" id="lbl-pieces">Piezas</label>
                <select class="btn-control" id="piece-theme-sel">
                    <option value="wikipedia">Wikipedia</option>
                    <option value="alpha">Alpha</option>
                    <option value="uscf">USCF</option>
                </select>
            </div>
        </div>

        <div class="drawer-section" style="margin-bottom:20px;">
            <label class="label-tiny" id="lbl-lang">üåê IDIOMA / LANGUAGE</label>
            <select class="btn-control" id="lang-sel">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
            </select>
        </div>

        <div class="drawer-item" id="btn-toggle-sound"
            style="cursor:pointer; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05);">üîä Sonidos: ON</div>
        <div style="padding:10px 0;">
            <a href="privacy.html" style="color:var(--text-muted); font-size:0.65rem; text-decoration:none;"
                target="_blank">üìú Pol√≠tica de Privacidad</a>
        </div>
        <div class="drawer-item" id="btn-delete-account" onclick="confirmDeleteAccount()"
            style="cursor:pointer; padding:10px 0; border-top:1px solid rgba(239, 68, 68, 0.1); color:#ef4444; font-size:0.7rem; opacity:0.8; display:none;">
            üóëÔ∏è Eliminar mi cuenta permanentemente</div>
        <div style="margin-top:auto; font-size:0.6rem; color:var(--text-muted);">V 2.5 - Cloud Edition</div>
    </div>

    <div class="app-container">
        <aside class="sidebar-left">
            <div id="main-menu-container">
                <!-- SECCI√ìN PARA NO AUTENTICADOS (Invitados) -->
                <div id="guest-access-section"
                    style="padding:15px; background:rgba(34, 197, 94, 0.05); border:1px solid rgba(34, 197, 94, 0.2); border-radius:12px; margin-bottom:15px; display:none;">
                    <p
                        style="font-size:0.75rem; color:var(--text-main); font-weight:700; text-align:center; margin-bottom:10px;">
                        ¬°MEJORA TU NIVEL!</p>
                    <p style="font-size:0.65rem; color:var(--text-muted); text-align:center; margin-bottom:12px;">
                        Reg√≠strate para guardar tu progreso, subir ELO y chatear.</p>
                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:8px;">
                        <button class="btn-primary" onclick="openAuth()" style="padding:8px; font-size:0.65rem;">INICIAR
                            SESI√ìN</button>
                        <button class="btn-tool" onclick="openAuth(); $('#auth-switch').click()"
                            style="padding:8px; font-size:0.65rem;">REGISTRO</button>
                    </div>
                </div>

                <!-- MENU PRINCIPAL (LEVEL 1) -->
                <div class="menu-step active" id="menu-root">
                    <div class="btn-menu" onclick="showSubMenu('lobby')"><span>üåê</span><span>Jugar Online</span></div>
                    <div class="btn-menu" onclick="showSubMenu('jugar')"><span>ü§ñ</span><span>Jugar vs IA / Local</span>
                    </div>
                    <div class="btn-menu" onclick="showSubMenu('estudio')"><span>üìö</span><span>Estudiar y
                            Analizar</span></div>
                    <div class="btn-menu" onclick="showSubMenu('puzzles')"><span>üß©</span><span>Puzzles T√°cticos</span>
                    </div>
                </div>

                <!-- SUBMENU: JUGAR -->
                <div class="menu-step" id="menu-jugar">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('root')" style="margin:0;">‚¨ÖÔ∏è VOLVER</button>
                    </div>

                    <div class="btn-menu" onclick="showSubMenu('maestro-setup')"><span>üë¥</span><span>Entrenamiento
                            Maestro IA</span></div>
                    <div class="btn-menu" onclick="setMode('pass-and-play')"><span>üë•</span><span>Duelo Local (2
                            Jugadores)</span></div>
                </div>

                <!-- SUBMENU: MAESTRO SETUP -->
                <div class="menu-step" id="menu-maestro-setup">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('jugar')" style="margin:0;">‚¨ÖÔ∏è Atras</button>
                        <button class="btn-back" onclick="showSubMenu('root')"
                            style="margin:0; font-size:0.6rem; color:var(--accent);">üè† Menu</button>
                    </div>
                    <div
                        style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; display:flex; flex-direction:column; gap:12px;">
                        <h3 style="font-size:0.8rem; color:var(--accent); text-align:center;">CONFIGURAR ENTRENAMIENTO
                        </h3>

                        <div>
                            <label class="label-tiny">ELIJE TU COLOR</label>
                            <select class="btn-control" id="maestro-color-sel" style="width:100%;">
                                <option value="w">Blancas (Empiezas t√∫)</option>
                                <option value="b">Negras (Empieza el Maestro)</option>
                                <option value="random" selected>Aleatorio</option>
                            </select>
                        </div>

                        <div>
                            <label class="label-tiny">TIEMPO POR JUGADOR</label>
                            <select class="btn-control" id="maestro-time-sel" style="width:100%;">
                                <option value="1">1 Minuto (Bullet)</option>
                                <option value="3">3 Minutos (Blitz)</option>
                                <option value="5">5 Minutos (Blitz)</option>
                                <option value="10" selected>10 Minutos (R√°pida)</option>
                                <option value="15">15 Minutos (R√°pida)</option>
                                <option value="1440">24 Horas (Correspondencia)</option>
                            </select>
                        </div>

                        <div>
                            <label class="label-tiny">DIFICULTAD DEL MAESTRO</label>
                            <select class="btn-control" id="maestro-diff-sel" style="width:100%;">
                                <option value="1">Principiante (600)</option>
                                <option value="5">Intermedio (1200)</option>
                                <option value="10">Avanzado (1800)</option>
                                <option value="15" selected>Experto (2200)</option>
                                <option value="20">Gran Maestro (2800+)</option>
                            </select>
                        </div>

                        <button class="btn-primary" onclick="startMaestroModeReal()" style="margin-top:10px;">üöÄ EMPEZAR
                            ENTRENAMIENTO</button>
                    </div>
                </div>

                <!-- SUBMENU: LOBBY (SALA ONLINE) -->
                <div class="menu-step" id="menu-lobby">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                        <button class="btn-back" onclick="showSubMenu('root')" style="margin:0;">üè† VOLVER AL
                            INICIO</button>
                        <div style="font-size:0.8rem; font-weight:bold; color:var(--accent);">SALA ONLINE üåê</div>
                    </div>

                    <!-- PESTA√ëAS LOBBY - SEPARACI√ìN TOTAL DE CATEGOR√çAS -->
                    <div style="display:flex; gap:5px; margin-bottom:15px;">
                        <button class="btn-tool active" onclick="filterLobby('live')" id="tab-lobby-live"
                            style="flex:1; font-size: 0.65rem;">‚ö° PARTIDAS CORTAS (-30m)</button>
                        <button class="btn-tool" onclick="filterLobby('daily')" id="tab-lobby-daily"
                            style="flex:1; font-size: 0.65rem;">üìÖ DIARIAS (24h)</button>
                    </div>

                    <!-- LISTA DE PARTIDAS ACTIVAS -->
                    <div
                        style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.05);">
                        <label class="label-tiny" style="color:var(--text-main);">MIS PARTIDAS EN CURSO</label>
                        <div id="lobby-active-games" style="max-height:150px; overflow-y:auto; min-height:40px;">
                            <!-- Populated by JS -->
                            <div style="text-align:center; padding:10px; color:var(--text-muted); font-size:0.7rem;">
                                Cargando...</div>
                        </div>
                    </div>

                    <!-- LISTA DE RETOS -->
                    <div
                        style="background:rgba(255,255,255,0.05); padding:10px; border-radius:10px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.05);">
                        <label class="label-tiny" style="color:var(--accent);">RETOS ABIERTOS</label>
                        <div id="lobby-challenges" style="max-height:150px; overflow-y:auto; min-height:40px;">
                            <!-- Populated by JS -->
                            <div style="text-align:center; padding:10px; color:var(--text-muted); font-size:0.7rem;">
                                Buscando oponentes...</div>
                        </div>
                    </div>

                    <!-- CREAR RETO -->
                    <button class="btn-primary" onclick="$('#lobby-create-panel').slideToggle()"
                        style="margin-bottom:10px;">‚ûï CREAR NUEVO RETO</button>

                    <div id="lobby-create-panel"
                        style="display:none; background:rgba(0,0,0,0.3); padding:15px; border-radius:10px; border:1px solid var(--accent);">
                        <label class="label-tiny" style="margin-bottom:5px; display:block;">Ritmo de Juego</label>
                        <select class="btn-control" id="online-time-sel-lobby" style="margin-bottom:15px;">
                            <option value="1">1 Minuto (Bala)</option>
                            <option value="3">3 Minutos (Blitz)</option>
                            <option value="10" selected>10 Minutos (Rapid)</option>
                            <option value="30">30 Minutos (Cl√°sico)</option>
                            <option value="1440">24 Horas (Daily)</option>
                        </select>
                        <button class="btn-tool" onclick="createOnlineChallenge(false, true)"
                            style="width:100%; border-color:var(--accent); color:var(--text-main);">‚öîÔ∏è PUBLICAR
                            RETO</button>
                    </div>
                </div>

                <!-- SUBMENU: ESTUDIO -->
                <div class="menu-step" id="menu-estudio">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('root')" style="margin:0;">‚¨ÖÔ∏è VOLVER</button>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:12px;">
                        <div class="btn-menu" onclick="showSubMenu('menu-estudio-aperturas')">
                            <span>üìñ</span><span>Aperturas Teor√≠a y Entrenamiento</span>
                        </div>
                        <div class="btn-menu" onclick="showSubMenu('menu-estudio-analisis')">
                            <span>üîç</span><span>An√°lisis y Herramientas</span>
                        </div>
                    </div>
                </div>

                <!-- SUBMENU: APERTURAS (ESTUDIO) -->
                <div class="menu-step" id="menu-estudio-aperturas">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('estudio')" style="margin:0;">‚¨ÖÔ∏è ATR√ÅS</button>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div class="btn-menu" onclick="showOpeningLibrary('theory')">
                            <span>üìö</span><span>Modo Teor√≠a (Explicaciones IA)</span>
                        </div>
                        <div class="btn-menu" onclick="showOpeningLibrary('training')">
                            <span>‚öîÔ∏è</span><span>Entrenamiento IA Maestro</span>
                        </div>
                        <div class="btn-menu" onclick="showOpeningLibrary('exercises')">
                            <span>üß©</span><span>Ejercicios de Apertura</span>
                        </div>
                    </div>
                </div>

                <!-- SUBMENU: SELECTOR DE APERTURA ESPECIFICA -->
                <div class="menu-step" id="menu-apertura-selector">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('estudio-aperturas')" style="margin:0;">‚¨ÖÔ∏è
                            ATR√ÅS</button>
                        <button class="btn-back" onclick="showSubMenu('root')"
                            style="margin:0; font-size:0.6rem; color:var(--accent);">üè† MEN√ö</button>
                    </div>
                    <div
                        style="background:var(--glass-bg); padding:15px; border-radius:12px; border:var(--border-glass);">
                        <label id="ap-sel-label"
                            style="display:block; margin-bottom:10px; font-size:0.7rem; color:var(--accent); font-weight:800;">SELECCIONA
                            APERTURA</label>
                        <select id="opening-sel-universal" class="input-main" style="margin-bottom:15px;"></select>

                        <div id="training-color-choice" style="display:none; margin-bottom:15px;">
                            <label
                                style="display:block; margin-bottom:10px; font-size:0.7rem; color:var(--text-muted); font-weight:800;">TU
                                COLOR</label>
                            <div style="display:grid; grid-template-columns:1fr 1fr; gap:10px;">
                                <button class="btn-tool color-btn active" data-color="white" style="padding:10px;">‚ö™
                                    Blancas</button>
                                <button class="btn-tool color-btn" data-color="black" style="padding:10px;">‚ö´
                                    Negras</button>
                            </div>
                        </div>

                        <button class="btn-primary" onclick="startOpeningModeFromSelector()"
                            style="width:100%;">COMENZAR</button>
                    </div>
                </div>

                <!-- SUBMENU: ANALISIS (ESTUDIO) -->
                <div class="menu-step" id="menu-estudio-analisis">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('estudio')" style="margin:0;">‚¨ÖÔ∏è ATR√ÅS</button>
                        <button class="btn-back" onclick="showSubMenu('root')"
                            style="margin:0; font-size:0.6rem; color:var(--accent);">üè† MEN√ö</button>
                    </div>
                    <div style="display:flex; flex-direction:column; gap:10px;">
                        <div class="btn-menu" onclick="setMode('study')">
                            <span>üìà</span><span>An√°lisis de Tablero</span>
                        </div>
                        <div class="btn-menu" id="btn-editor-main">
                            <span>‚õèÔ∏è</span><span>Editor de Posiciones</span>
                        </div>
                        <div class="btn-menu" onclick="resetGamePosition()">
                            <span>üßπ</span><span>Reiniciar Tablero</span>
                        </div>
                        <div class="btn-menu" id="btn-pgn-main">
                            <span>üìÑ</span><span>Importar PGN</span>
                        </div>
                    </div>
                </div>

                <!-- SUBMENU: PUZZLES -->
                <div class="menu-step" id="menu-puzzles">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <button class="btn-back" onclick="showSubMenu('root')" style="margin:0;">‚¨ÖÔ∏è ATR√ÅS</button>
                        <button class="btn-back" onclick="showSubMenu('root')"
                            style="margin:0; font-size:0.6rem; color:var(--accent);">üè† MEN√ö</button>
                    </div>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:10px;">
                        <button class="btn-menu" onclick="setPuzzleCat('mixed')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">üß©</span>
                            <span style="font-size:0.65rem;">Mezclados</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('mateIn1')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">‚òùÔ∏è</span>
                            <span style="font-size:0.65rem;">Mate en 1</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('mateIn2')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">‚úåÔ∏è</span>
                            <span style="font-size:0.65rem;">Mate en 2</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('mateIn3')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">ü§ü</span>
                            <span style="font-size:0.65rem;">Mate en 3</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('midgame')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">‚öîÔ∏è</span>
                            <span style="font-size:0.65rem;">Medio Juego</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('endgame')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">üèÅ</span>
                            <span style="font-size:0.65rem;">Finales</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('opening')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">üìñ</span>
                            <span style="font-size:0.65rem;">Aperturas</span>
                        </button>
                        <button class="btn-menu" onclick="setPuzzleCat('advanced')"
                            style="padding:10px; flex-direction:column; gap:5px; height:auto;">
                            <span style="font-size:1.2rem; background:none; width:auto; height:auto;">üèÜ</span>
                            <span style="font-size:0.65rem;">Avanzados</span>
                        </button>
                    </div>
                </div>
            </div>

            <div id="puzzles-setup-controls" class="game-sidebar-controls"
                style="display:none; flex-direction:column; gap:10px; margin-top:15px;">
                <button class="btn-primary" id="btn-flip"
                    style="background:rgba(255,255,255,0.05); border:1px solid rgba(255,255,255,0.1); color:var(--text-muted); padding:10px;">üîÑ
                    GIRAR TABLERO</button>

                <button class="btn-menu" id="btn-resign-game"
                    style="background:rgba(239, 68, 68, 0.1); border-color:rgba(239, 68, 68, 0.2); color:#ef4444; padding:10px;">
                    <span>üè≥Ô∏è</span><span>Rendirse</span>
                </button>

                <button class="btn-menu" id="btn-abort-game"
                    style="background:rgba(245, 158, 11, 0.1); border-color:rgba(245, 158, 11, 0.2); color:#f59e0b; padding:10px;">
                    <span>‚èπÔ∏è</span><span>Abortar Partida</span>
                </button>

                <button class="btn-menu" onclick="goBackToMenu()"
                    style="background:rgba(59, 130, 246, 0.1); border-color:rgba(59, 130, 246, 0.2); color:#3b82f6; padding:10px;">
                    <span>üè†</span><span>Volver al Men√∫</span>
                </button>

                <!-- SELECTOR DE CATEGOR√çAS RAPIDO PARA PUZZLES -->
                <div id="puzzle-categories-sidebar"
                    style="display:none; margin-top:10px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                    <label class="label-tiny" style="margin-bottom:8px; display:block; text-align:center;">CAMBIAR TIPO
                        DE PUZZLE</label>
                    <div style="display:grid; grid-template-columns: 1fr 1fr; gap:6px;">
                        <button class="btn-tool" onclick="setPuzzleCat('mixed')"
                            style="font-size:0.55rem; padding:8px;">üß© Mezclados</button>
                        <button class="btn-tool" onclick="setPuzzleCat('mateIn1')"
                            style="font-size:0.55rem; padding:8px;">‚òùÔ∏è Mate en 1</button>
                        <button class="btn-tool" onclick="setPuzzleCat('mateIn2')"
                            style="font-size:0.55rem; padding:8px;">‚úåÔ∏è Mate en 2</button>
                        <button class="btn-tool" onclick="setPuzzleCat('mateIn3')"
                            style="font-size:0.55rem; padding:8px;">ü§ü Mate en 3</button>
                        <button class="btn-tool" onclick="setPuzzleCat('midgame')"
                            style="font-size:0.55rem; padding:8px;">‚öîÔ∏è Medio Juego</button>
                        <button class="btn-tool" onclick="setPuzzleCat('endgame')"
                            style="font-size:0.55rem; padding:8px;">üèÅ Finales</button>
                    </div>
                </div>
            </div>


        </aside>

        <div class="game-zone">
            <!-- TIMER OPONENTE -->
            <div class="player-info" id="p-top">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div id="opp-avatar" style="font-size:1.2rem;">üë§</div>
                    <span id="opp-name" style="font-size:0.8rem; font-weight:700;">Oponente</span>
                </div>
                <div id="opp-timer" class="timer-box">10:00</div>
            </div>

            <div id="board-container" style="position:relative; width:100%; max-width:450px; display:flex; gap:8px;">
                <!-- BARRA DE EVALUACI√ìN VERTICAL ESTILO LICHESS -->
                <div class="eval-bar-v-wrap">
                    <div class="eval-bar-fill" id="eval-fill-master" style="height:50%;"></div>
                </div>

                <div style="flex:1; position:relative;">
                    <div id="material-display"
                        style="position:absolute; top:-25px; right:0; color:#aaa; font-size:0.7rem; font-weight:bold;">
                    </div>
                    <div id="myBoard" class="board-3d-effect"></div>
                    <!-- Punto de Peligro IA -->
                    <div id="danger-dot" class="danger-dot" style="display:none;" onclick="showDangerExplanation()">
                    </div>

                    <!-- Capa para flechas del Maestro -->
                    <canvas id="arrowCanvas"
                        style="position:absolute; top:0; left:0; width:100%; height:100%; pointer-events:none; z-index:1000;"></canvas>
                    <div id="book-move-indicator"
                        style="position:absolute; bottom:10px; right:10px; background:rgba(139, 92, 246, 0.9); color:white; padding:4px 10px; border-radius:15px; font-size:0.6rem; font-weight:800; display:none; z-index:1001; box-shadow:0 2px 10px rgba(0,0,0,0.3); border:1px solid rgba(255,255,255,0.2);">
                        üìñ TEOR√çA</div>
                    <div id="game-overlay"
                        style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:999; border-radius:4px; transition:0.3s;">
                        <h2 id="overlay-msg"
                            style="color:var(--accent); text-shadow:0 0 15px var(--accent); margin-bottom:20px; font-size:2rem;">
                            JAQUE MATE</h2>
                        <button class="btn-primary" onclick="$('#game-overlay').fadeOut()"
                            style="width:auto; padding:10px 25px;">CERRAR</button>
                    </div>
                </div>
            </div>

            <!-- CONTROLES PUZZLE DEBAJO DEL TABLERO -->
            <div id="puzzle-controls-bottom"
                style="display:none; width:100%; max-width:450px; overflow-x:auto; white-space:nowrap; gap:5px; padding:5px 0; scrollbar-width:none;">
                <button class="btn-tool" onclick="setPuzzleCat('mixed')" style="font-size:0.6rem; padding:6px 10px;">üß©
                    Mix</button>
                <button class="btn-tool" onclick="setPuzzleCat('mateIn1')"
                    style="font-size:0.6rem; padding:6px 10px;">‚òùÔ∏è Mate 1</button>
                <button class="btn-tool" onclick="setPuzzleCat('mateIn2')"
                    style="font-size:0.6rem; padding:6px 10px;">‚úåÔ∏è Mate 2</button>
                <button class="btn-tool" onclick="setPuzzleCat('midgame')"
                    style="font-size:0.6rem; padding:6px 10px;">‚öîÔ∏è Medio</button>
                <button class="btn-tool" onclick="setPuzzleCat('endgame')"
                    style="font-size:0.6rem; padding:6px 10px;">üèÅ Final</button>
                <button class="btn-tool" onclick="setPuzzleCat('opening')"
                    style="font-size:0.6rem; padding:6px 10px;">üìñ Apertura</button>
            </div>

            <!-- CONTROLES DE NAVEGACI√ìN -->
            <div class="nav-toolbar">
                <button class="btn-nav" id="btn-nav-first" title="Inicio">‚èÆ</button>
                <button class="btn-nav" id="btn-nav-prev" title="Anterior">‚óÄ</button>
                <button class="btn-nav" id="btn-nav-next" title="Siguiente">‚ñ∂</button>
                <button class="btn-nav" id="btn-nav-last" title="Fin">‚è≠</button>
            </div>

            <!-- REPORTE DE AN√ÅLISIS ESTILO CHESSIS -->
            <div id="analysis-report-container"
                style="display:none; width:100%; max-width:450px; background:var(--glass-bg); backdrop-filter:var(--glass-blur); border-radius:12px; border:var(--border-glass); margin-top:15px; padding:15px; animation:fadeIn 0.4s ease;">
                <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:15px;">
                    <h3 style="font-size:0.9rem; color:var(--accent);">AN√ÅLISIS DE PARTIDA</h3>
                    <button class="btn-tool" onclick="$('#analysis-report-container').fadeOut()"
                        style="padding:4px 8px;">CERRAR</button>
                </div>

                <div style="display:grid; grid-template-columns: 1fr 1fr; gap:15px; margin-bottom:20px;">
                    <div style="text-align:center; background:rgba(255,255,255,0.03); padding:10px; border-radius:8px;">
                        <div id="accuracy-display" style="font-size:2rem; font-weight:800; color:var(--accent);">--%
                        </div>
                        <div class="label-tiny">PRECISI√ìN TOTAL</div>
                    </div>
                    <div style="display:flex; flex-direction:column; justify-content:center; gap:4px;">
                        <div id="phase-opening" style="font-size:0.6rem; color:var(--text-muted);">Apertura: --%</div>
                        <div id="phase-middlegame" style="font-size:0.6rem; color:var(--text-muted);">Medio Juego: --%
                        </div>
                        <div id="phase-endgame" style="font-size:0.6rem; color:var(--text-muted);">Final: --%</div>
                    </div>
                </div>

                <!-- Gr√°fico de Evaluaci√≥n -->
                <div
                    style="width:100%; height:120px; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:15px; position:relative; overflow:hidden;">
                    <canvas id="evalChart"></canvas>
                </div>

                <!-- Detalles de Jugadas -->
                <div class="quality-grid" style="display:grid; grid-template-columns: repeat(3, 1fr); gap:8px;">
                    <div class="quality-stat brilliance"
                        style="display:flex; align-items:center; gap:8px; background:rgba(167, 139, 250, 0.1); padding:8px; border-radius:6px; border:1px solid rgba(167, 139, 250, 0.2);">
                        <span class="q-icon" style="color:#a78bfa; font-weight:900;">!!</span> <span id="stat-brilliant"
                            style="font-weight:700;">0</span>
                    </div>
                    <div class="quality-stat great"
                        style="display:flex; align-items:center; gap:8px; background:rgba(56, 189, 248, 0.1); padding:8px; border-radius:6px; border:1px solid rgba(56, 189, 248, 0.2);">
                        <span class="q-icon" style="color:var(--accent); font-weight:900;">!</span> <span
                            id="stat-great" style="font-weight:700;">0</span>
                    </div>
                    <div class="quality-stat best"
                        style="display:flex; align-items:center; gap:8px; background:rgba(16, 185, 129, 0.1); padding:8px; border-radius:6px; border:1px solid rgba(16, 185, 129, 0.2);">
                        <span class="q-icon" style="color:#10b981; font-weight:900;">‚≠ê</span> <span id="stat-best"
                            style="font-weight:700;">0</span>
                    </div>
                    <div class="quality-stat inaccuracy"
                        style="display:flex; align-items:center; gap:8px; background:rgba(251, 191, 36, 0.1); padding:8px; border-radius:6px; border:1px solid rgba(251, 191, 36, 0.2);">
                        <span class="q-icon" style="color:#fbbf24; font-weight:900;">?!</span> <span
                            id="stat-inaccuracy" style="font-weight:700;">0</span>
                    </div>
                    <div class="quality-stat mistake"
                        style="display:flex; align-items:center; gap:8px; background:rgba(249, 115, 22, 0.1); padding:8px; border-radius:6px; border:1px solid rgba(249, 115, 22, 0.2);">
                        <span class="q-icon" style="color:#f97316; font-weight:900;">?</span> <span id="stat-mistake"
                            style="font-weight:700;">0</span>
                    </div>
                    <div class="quality-stat blunder"
                        style="display:flex; align-items:center; gap:8px; background:rgba(239, 68, 68, 0.1); padding:8px; border-radius:6px; border:1px solid rgba(239, 68, 68, 0.2);">
                        <span class="q-icon" style="color:#ef4444; font-weight:900;">??</span> <span id="stat-blunder"
                            style="font-weight:700;">0</span>
                    </div>
                </div>

                <div id="analysis-progress-bar"
                    style="height:4px; width:0; background:var(--accent); margin-top:15px; border-radius:2px; transition: width 0.3s;">
                </div>
            </div>

            <!-- BARRA DE ACCIONES SECUNDARIA (SOLO M√ìVIL) -->
            <div class="mobile-actions-bar mobile-only">
                <button class="btn-action" id="btn-hint-mobile-bar">üí° PISTA</button>
                <button class="btn-action" id="btn-drills-mobile-bar">üß™ EJERCICIOS</button>
                <button class="btn-action resign">üè≥Ô∏è RENDIRSE</button>
                <button class="btn-action menu">üè† VOLVER</button>
            </div>

            <!-- BOT√ìN PISTAS IA (Para PC, visible en modos entrenamiento) -->
            <button class="btn-primary desktop-only" id="btn-hint-main"
                style="width:200px; padding:8px; margin: 10px auto; font-size:0.8rem; display:none; align-items:center; justify-content:center; gap:5px; background:var(--accent-gold); border-color:#d97706; color:#000; font-weight:800; border-radius:12px;">üí°
                PISTA IA INTERACTIVA</button>

            <!-- MEN√ö DESPLEGABLE DE ACCIONES M√ìVIL -->
            <div id="mobile-actions-menu" class="glass-dropdown">
                <button class="dropdown-item" id="btn-flip-mobile">üîÑ Girar Tablero</button>
                <button class="dropdown-item" id="btn-analyze-mobile">üîç Analizar</button>
                <button class="dropdown-item" id="btn-hint-mobile">üí° Pista IA</button>
                <button class="dropdown-item" id="btn-editor-mobile">‚õèÔ∏è Editor</button>
            </div>

            <!-- TIMER JUGADOR -->
            <div class="player-info" id="p-bottom">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div id="my-avatar" style="font-size:1.2rem;">üë§</div>
                    <span id="my-name-display" style="font-size:0.8rem; font-weight:700;">Invitado</span>
                </div>
                <div id="my-timer" class="timer-box">10:00</div>
            </div>
        </div>

        <aside class="sidebar-right">
            <!-- CONTROLES SUPERIORES (PC) - Visible solo en modos de juego -->
            <div id="sidebar-game-controls" class="game-sidebar-controls"
                style="display:none; flex-direction:column; gap:8px; margin-bottom:15px; padding-bottom:15px; border-bottom:1px solid rgba(255,255,255,0.05);">
                <button class="btn-primary" id="btn-back-menu-pc" onclick="goBackToMenu()"
                    style="width:100%; display:flex; align-items:center; justify-content:center; gap:8px;">
                    üè† VOLVER AL MEN√ö
                </button>
                <div style="display:flex; gap:5px;">
                    <button class="btn-tool" id="btn-flip-pc-sidebar"
                        style="flex:1; background:rgba(255,255,255,0.05);">üîÑ Girar</button>
                    <button class="btn-tool" id="btn-reset-board-pc"
                        style="flex:1; background:rgba(255,255,255,0.05);">üßπ Reiniciar</button>
                    <button class="btn-tool" onclick="game.undo(); board.position(game.fen()); updateUI();"
                        style="flex:1; background:rgba(255,255,255,0.05); color:var(--accent);">‚è™ Anterior</button>
                </div>
            </div>

            <!-- MAESTRO IA PANEL REFINADO (PC) -->
            <div class="master-panel" id="master-coach-panel"
                style="margin-top:5px; display:none; flex-direction:column; border-radius:12px 12px 0 0; background:rgba(0,0,0,0.3); border-bottom:none;">
                <div class="master-content" style="padding:15px;">
                    <div id="coach-txt" class="master-text"
                        style="text-align:left; font-style:italic; font-size:0.75rem; min-height:60px;">
                        Inicia un reto para empezar tu entrenamiento...
                    </div>
                    <div id="best-move-display" class="best-move-box"></div>
                </div>
            </div>

            <!-- HISTORIAL DE MOVIMIENTOS EN VIVO -->
            <div id="current-moves-sidebar"
                style="display:none; flex-direction:column; background:rgba(0,0,0,0.25); padding:10px; border-radius:0 0 12px 12px; margin-bottom:15px; border:1px solid rgba(255,255,255,0.05); border-top:none;">
                <label class="label-tiny" style="margin-bottom:8px; opacity:0.7;">HISTORIAL DE LA PARTIDA</label>
                <div class="live-moves-grid" id="game-moves-list">
                    <!-- Se llena con client.js -->
                </div>

                <!-- CONTROLES ESPEC√çFICOS DE AN√ÅLISIS/ESTUDIO -->
                <div id="study-extra-controls"
                    style="margin-top:8px; display:none; flex-direction:column; gap:8px; border-top:1px solid rgba(255,255,255,0.05); padding-top:10px;">
                    <div style="display:flex; justify-content:space-between; align-items:center;">
                        <span style="font-size:0.6rem; color:var(--text-muted); font-weight:800;">AUTO-MOVIMIENTO</span>
                        <div class="toggle-switch" onclick="toggleOpponentAutoMode()">
                            <div id="opp-move-toggle" class="toggle-btn"
                                style="background:#475569; width:70px; height:22px; border-radius:11px; position:relative; cursor:pointer; display:flex; align-items:center; padding:0 5px; font-size:0.5rem; font-weight:800; color:white;">
                                <span id="opp-mode-label" style="margin:auto;">MANUAL</span>
                                <div id="opp-mode-dot"
                                    style="position:absolute; left:2px; height:18px; width:18px; background:white; border-radius:50%; transition:0.3s;">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div style="display:grid; grid-template-columns:1fr 1fr; gap:5px;">
                        <button class="btn-tool" onclick="toggleHints()" id="btn-toggle-hints-study"
                            style="font-size:0.6rem; padding:6px;">üí° PISTAS</button>
                        <button class="btn-tool" id="btn-reset-board-pc-action" onclick="resetGamePosition()"
                            style="font-size:0.6rem; padding:6px;">üßπ REINICIAR</button>
                    </div>
                </div>
            </div>

            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="tab-play">‚öôÔ∏è JUEGO</button>
                <button class="tab-btn" data-tab="tab-chat">üí¨ CHAT</button>
                <button class="tab-btn" data-tab="tab-history">üìú HISTORIAL</button>
                <button class="tab-btn" data-tab="tab-ranking">üèÜ RANKING</button>
            </div>

            <!-- TAB: JUEGO -->
            <div class="tab-content active" id="tab-play">
                <!-- MODO LOCAL / ONLINE -->
                <div class="mode-section active" id="sec-local">
                    <!-- CONTROLES DE PARTIDA (PC) -->
                    <div class="desktop-only"
                        style="display:grid; grid-template-columns: 1fr 1fr 1fr; gap:5px; margin-bottom:15px; padding-bottom:10px; border-bottom:1px solid rgba(255,255,255,0.05);">
                        <button class="btn-tool" onclick="goBackToMenu()" style="font-size:0.7rem;">üè† Men√∫</button>
                        <button class="btn-tool" id="btn-flip-pc-local" style="font-size:0.7rem;">üîÑ Girar</button>
                        <button class="btn-danger" id="btn-resign-local-pc" style="font-size:0.7rem;">üè≥Ô∏è
                            Rendirse</button>
                    </div>

                    <label class="label-tiny">MIS PARTIDAS ACTIVAS</label>
                    <div id="active-games-list"
                        style="max-height:150px; overflow-y:auto; background:rgba(34, 197, 94, 0.05); border:1px solid rgba(34, 197, 94, 0.2); border-radius:8px; margin-bottom:10px; padding:5px;">
                        <div style="font-size:0.65rem; color:var(--text-muted); text-align:center; padding:10px;">
                            Cargando partidas...</div>
                    </div>

                    <label class="label-tiny">SALA DE JUEGO (RETOS)</label>
                    <div id="challenges-list"
                        style="max-height:120px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:10px; padding:5px;">
                        <div style="font-size:0.65rem; color:var(--text-muted); text-align:center; padding:10px;">
                            Buscando retos...</div>
                    </div>

                    <button class="btn-primary" id="btn-create" style="width:100%; margin-bottom:10px;">‚öîÔ∏è CREAR NUEVO
                        RETO</button>

                    <!-- CONTROLES M√ìVIL -->
                    <div class="mobile-only" style="display:flex; gap:5px; margin-top:5px;">
                        <button class="btn-tool" onclick="game.undo(); board.position(game.fen()); updateUI();"
                            style="flex:1;">‚è™ ATR√ÅS</button>
                        <button class="btn-danger" id="btn-resign-local" style="flex:1;">RENDIRSE</button>
                    </div>
                    <button class="btn-tool" onclick="goBackToMenu()" style="width:100%; margin-top:5px;">üè† VOLVER AL
                        MEN√ö</button>
                </div>

                <!-- MODO IA -->
                <div class="mode-section" id="sec-ai">
                    <button class="btn-tool" onclick="goBackToMenu()"
                        style="width:100%; margin-bottom:15px; border-color:rgba(255,255,255,0.1);">üè† VOLVER AL
                        MEN√ö</button>

                    <label class="label-tiny">TIEMPO DE JUEGO</label>
                    <div class="time-selector-grid" id="ai-time-selector">
                        <button class="time-btn" data-time="1">1 min</button>
                        <button class="time-btn" data-time="3">3 min</button>
                        <button class="time-btn active" data-time="10">10 min</button>
                    </div>
                    <label class="label-tiny">COLOR</label>
                    <select class="btn-control" id="ai-color-sel" style="margin-bottom:10px;">
                        <option value="w">Blancas</option>
                        <option value="b">Negras</option>
                        <option value="random">Aleatorio</option>
                    </select>
                    <label class="label-tiny">DIFICULTAD DE LA IA</label>
                    <select class="btn-control" id="diff-sel">
                        <option value="1">Nivel 1 (ELO 500)</option>
                        <option value="3">Nivel 3 (ELO 800)</option>
                        <option value="5">Nivel 5 (ELO 1100)</option>
                        <option value="8">Nivel 8 (ELO 1400)</option>
                        <option value="10" selected>Nivel 10 (ELO 1700)</option>
                        <option value="15">Nivel 15 (ELO 2100)</option>
                        <option value="20">Nivel 20 (ELO 2500+)</option>
                    </select>

                    <button class="btn-primary" id="btn-start-ai">EMPEZAR PARTIDA</button>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="btn-danger" id="btn-resign-ai" style="flex:1;">RENDIRSE</button>
                        <button class="btn-tool" id="btn-reset-ai" onclick="resetGamePosition()" style="flex:1;">üßπ
                            REINICIAR</button>
                    </div>
                    <button class="btn-tool" id="btn-ai-hint" style="width:100%; margin-top:8px;">üí° ACTIVAR
                        PISTAS</button>
                </div>

                <!-- MODO ESTUDIO -->
                <div class="mode-section" id="sec-study">
                    <button class="btn-tool" onclick="goBackToMenu()"
                        style="width:100%; margin-bottom:15px; border-color:rgba(255,255,255,0.1);">üè† VOLVER AL
                        MEN√ö</button>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                        <label class="label-tiny" style="margin:0;">BIBLIOTECA DE APERTURAS</label>
                        <button class="btn-tool" id="btn-openings-study"
                            style="font-size:0.55rem; padding:4px 8px; border-radius:6px; color:var(--accent); border-color:var(--accent);">üìñ
                            BIBLIOTECA</button>
                    </div>

                    <select class="btn-control" id="opening-sel">
                        <option value="">-- Seleccionar --</option>
                    </select>

                    <div id="study-controls"
                        style="display:none; margin-top:10px; background:rgba(0,0,0,0.2); padding:10px; border-radius:8px;">
                        <button class="btn-primary" id="btn-study-next" style="width:100%; margin-bottom:5px;">‚è©
                            Siguiente Jugada</button>
                        <div style="display:flex; gap:5px;">
                            <button class="btn-tool" id="btn-study-prev" style="flex:2;">‚è™ Anterior</button>
                            <button class="btn-tool" onclick="resetGamePosition()" style="flex:1;"
                                title="Reiniciar Posici√≥n">üßπ</button>
                        </div>
                    </div>

                    <div
                        style="margin-top:15px; border-top:1px solid rgba(255,255,255,0.1); padding-top:10px; display:block;">
                        <label class="label-tiny">HERRAMIENTAS</label>
                        <div class="tool-grid">
                            <button class="btn-tool"
                                onclick="game.reset(); board.start(); updateUI(); $('#study-controls').hide();">üîÑ
                                RESET</button>
                            <button class="btn-tool" id="btn-pgn">üìÇ PGN</button>
                            <button class="btn-tool" id="btn-editor">‚õèÔ∏è EDITOR</button>
                            <button class="btn-tool" onclick="alert(game.fen())">üìã FEN</button>
                        </div>
                    </div>
                </div>

                <!-- MODO PUZZLES -->
                <div class="mode-section" id="sec-exercises">
                    <button class="btn-tool" onclick="goBackToMenu()"
                        style="width:100%; margin-bottom:15px; border-color:rgba(255,255,255,0.1);">üè† VOLVER AL
                        MEN√ö</button>

                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <label class="label-tiny" style="margin:0;">CATEGOR√çA</label>
                        <div id="puz-timer"
                            style="color:var(--accent); font-weight:800; font-family:monospace; font-size:1rem;">00:00
                        </div>
                    </div>
                    <select class="btn-control" id="puz-cat-sel">
                        <option value="all">Todos los puzzles</option>
                        <option value="opening">Aperturas</option>
                        <option value="middlegame">Juego Medio</option>
                        <option value="endgame">Finales</option>
                    </select>
                    <div
                        style="background:rgba(0,0,0,0.2); padding:12px; border-radius:10px; margin-bottom:10px; margin-top:8px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <h4 style="color:var(--accent); font-size:0.8rem;">Resolver</h4>
                            <span id="puz-elo-display" style="font-size:0.6rem; color:#3b82f6; font-weight:800;">ELO
                                PUZ: 500</span>
                        </div>
                        <p id="puz-desc" style="font-size:0.7rem; color:var(--text-main); line-height:1.4;">Cargando
                            puzzle...</p>
                    </div>
                    <div class="tool-grid" style="margin-bottom:10px;">
                        <button class="btn-primary" id="btn-next-puz" style="padding:10px;">SALTAR</button>
                        <button class="btn-tool" id="btn-puz-hint" style="color:var(--accent);">Pista üí°</button>
                        <button class="btn-tool" id="btn-show-sol"
                            style="grid-column: span 2; border-color:#3b82f6;">Ver
                            Soluci√≥n üëÄ</button>
                    </div>
                </div>
            </div>

            <!-- TAB: CHAT -->
            <div class="tab-content" id="tab-chat">
                <div class="chat-container" style="height:100%; border:none; background:transparent; margin-top:0;">
                    <div class="chat-messages" id="chat-msgs" style="background:rgba(0,0,0,0.1); border-radius:8px;">
                        <div style="color:var(--text-muted); text-align:center; margin:auto; font-size:0.65rem;">
                            Bienvenido al chat global</div>
                    </div>
                    <div id="emoji-bar"
                        style="display:flex; gap:8px; padding:5px; flex-wrap:wrap; justify-content:center;">
                        <button class="btn-emoji" data-emoji="üòÄ">üòÄ</button>
                        <button class="btn-emoji" data-emoji="üî•">üî•</button>
                        <button class="btn-emoji" data-emoji="üëè">üëè</button>
                        <button class="btn-emoji" data-emoji="üòÆ">üòÆ</button>
                        <button class="btn-emoji" data-emoji="ü§ù">ü§ù</button>
                        <button class="btn-emoji" data-emoji="üíÄ">üíÄ</button>
                        <button class="btn-emoji" data-emoji="‚≠ê">‚≠ê</button>
                    </div>
                    <div class="chat-input-wrap" style="margin-top:5px;">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Mensaje...">
                        <button id="btn-chat-send"
                            style="background:var(--accent); border:none; color:white; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.75rem;">ENVIAR</button>
                    </div>
                </div>
            </div>

            <!-- TAB: RANKING -->
            <div class="tab-content" id="tab-ranking">
                <label class="label-tiny">TOP 10 MUNDIAL</label>
                <div class="ranking-list" id="global-ranking">
                    <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.7rem;">Cargando
                        jugadores...</div>
                </div>
            </div>

            <!-- TAB: HISTORIAL -->
            <div class="tab-content" id="tab-history">
                <label class="label-tiny">MIS PARTIDAS RECIENTES</label>
                <div id="history-list" style="display:flex; flex-direction:column; gap:8px;">
                    <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.7rem;">No hay
                        partidas guardadas.</div>
                </div>
            </div>
        </aside>
    </div>

    <!-- SCRIPTS EN ORDEN CORRECTO -->
    <script src="puzzles_data.js"></script>
    <script src="openings_enhanced.js"></script>
    <script src="client.js"></script>

    <!-- ‚ö° OPTIMIZACIONES - CARGAR AL FINAL -->
    <script src="client_optimized.js"></script>

    <!-- ESTUDIO DE MODO - CARGAR DESPU√âS DE OPTIMIZACIONES -->
    <script src="study_mode_enhancements.js"></script>

    <script>
        // INICIALIZACI√ìN FINAL Y VERIFICACIONES
        window.addEventListener('load', function () {
            console.log('‚úÖ Aplicaci√≥n cargada con optimizaciones');

            // Verificar que las optimizaciones se cargaron
            if (window.chessOptimizations) {
                console.log('‚úÖ Optimizaciones activas:', window.chessOptimizations.version);
            }

            // Touch events para m√≥vil (prevenir zoom accidental)
            let lastTouchEnd = 0;
            document.addEventListener('touchend', function (e) {
                const now = Date.now();
                if (now - lastTouchEnd <= 300) {
                    e.preventDefault();
                }
                lastTouchEnd = now;
            }, { passive: false });

            // Prevenir zoom con gestos
            document.addEventListener('gesturestart', function (e) {
                e.preventDefault();
            });

            // Forzar resize del tablero despu√©s de carga completa
            setTimeout(() => {
                if (typeof board !== 'undefined' && board && board.resize) {
                    board.resize();
                    console.log('üìê Board resized');
                }
            }, 1000);
        });

        // Manejo de errores global
        window.addEventListener('error', function (e) {
            console.error('‚ùå Error capturado:', e.message);
            // Mostrar errores solo si son cr√≠ticos para la funcionalidad
            if (e.message && (e.message.includes('Stockfish') || e.message.includes('socket'))) {
                if (typeof showToast === 'function') {
                    showToast('Error de conexi√≥n, intentando reconectar...', '‚ö†Ô∏è');
                }
            }
        });

        <!-- Modal de Alerta de Maestro -->
        <div id="danger-alert-box" class="glass-modal"
            style="display:none; position:fixed; top:50%; left:50%; transform:translate(-50%,-50%); z-index:10000; width:90%; max-width:320px; padding:25px; text-align:center;">
            <div style="font-size:2rem; margin-bottom:15px;">‚ö†Ô∏è</div>
            <div id="danger-title" style="color:#ef4444; font-weight:800; font-size:1.1rem; margin-bottom:10px;">¬°AMENAZA
                DETECTADA!</div>
            <div id="danger-desc" style="font-size:0.85rem; line-height:1.6; margin-bottom:20px; color:var(--text-main);">
            </div>
            <div style="font-size:0.75rem; color:var(--text-muted); margin-bottom:20px; font-style:italic;">Busca una
                jugada de defensa o un contraataque inmediato.</div>
            <button class="btn-primary" onclick="$('#danger-alert-box').fadeOut()" style="width:100%;">ENTENDIDO</button>
        </div>

        // Service Worker para PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('sw.js')
                    .then(reg => console.log('‚úÖ SW registrado'))
                    .catch(err => console.log('SW error:', err));
            });
        }
    </script>
</body>

</html>