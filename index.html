<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>CHESS AI PRO - ONLINE</title>

    <!-- LIBRER√çAS (CDN para que funcione en internet sin l√≠os de archivos si faltan) -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --accent: #22c55e;
            --bg-dark: #0f172a;
            --panel-bg: rgba(30, 41, 59, 0.7);
            --text-main: #f1f5f9;
            --text-muted: #94a3b8;
            --trap-color: #ef4444;
            --success: #22c55e;
            --neon-glow: 0 0 10px rgba(34, 197, 94, 0.5);
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        /* FIX MOBILE: Permitir scroll en el body si el contenido es largo */
        body {
            background-color: var(--bg-dark);
            color: var(--text-main);
            font-family: 'Inter', sans-serif;
            min-height: 100vh;
            display: flex;
            flex-direction: column;
            overflow-x: hidden;
            overflow-y: auto;
            /* Permitir scroll vertical */
        }

        .app-header {
            height: 40px;
            background: #1e293b;
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 15px;
            border-bottom: 2px solid var(--accent);
            z-index: 1000;
            flex-shrink: 0;
            position: sticky;
            top: 0;
        }

        .logo-inline h1 {
            font-size: 0.9rem;
            margin: 0;
        }

        /* FIX MOBILE: Quitar height fijo de 1vh para permitir que crezca */
        .app-container {
            display: flex;
            flex-direction: column;
            flex: 1;
            padding: 8px;
            gap: 8px;
            max-width: 1200px;
            margin: 0 auto;
            width: 100%;
        }

        .sidebar-left {
            width: 100%;
            order: 1;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .game-zone {
            width: 100%;
            order: 2;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 8px;
        }

        .sidebar-right {
            width: 100%;
            order: 3;
            display: flex;
            flex-direction: column;
            gap: 8px;
            padding-bottom: 20px;
        }

        @media (max-width: 900px) {
            .game-zone {
                order: 1;
            }

            .sidebar-right {
                order: 2;
            }

            .sidebar-left {
                order: 3;
            }

            .mode-selectors {
                display: flex !important;
                flex-direction: row !important;
                overflow-x: auto;
                gap: 8px;
                padding: 5px 0;
            }

            .mode-pill {
                flex: 0 0 auto;
                min-width: 100px;
            }

            .tab-content {
                height: 380px;
            }
        }

        .mode-selectors {
            display: grid;
            grid-template-columns: 1fr 1fr;
            width: 100%;
            gap: 6px;
        }

        .mode-pill {
            background: rgba(30, 41, 59, 0.5);
            color: #94a3b8;
            font-size: 0.6rem;
            font-weight: 700;
            padding: 12px 5px;
            border-radius: 10px;
            border: 1px solid rgba(255, 255, 255, 0.05);
            cursor: pointer;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 4px;
            text-transform: uppercase;
        }

        .mode-pill.active {
            background: rgba(34, 197, 94, 0.15);
            color: var(--accent);
            border-color: var(--accent);
            box-shadow: var(--neon-glow);
        }

        .mode-section {
            display: none;
            background: rgba(15, 23, 42, 0.3);
            padding: 10px;
            border-radius: 12px;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .mode-section.active {
            display: block;
        }

        #myBoard {
            width: 100%;
            max-width: 400px;
            aspect-ratio: 1/1;
            margin: 0 auto;
            border: 4px solid #334155;
            border-radius: 8px;
            box-shadow: 0 20px 50px rgba(0, 0, 0, 0.5);
            touch-action: none;
        }

        @media (max-width: 450px) {
            .app-header h1 {
                font-size: 0.9rem;
            }

            .mode-pill {
                padding: 10px 4px;
                font-size: 0.55rem;
            }

            .nav-toolbar .btn-nav {
                padding: 15px 5px;
                font-size: 1.2rem;
            }

            .master-text {
                font-size: 0.75rem;
            }

            .timer-box {
                font-size: 0.9rem;
                min-width: 70px;
            }
        }

        .btn-primary {
            background: var(--accent);
            color: white;
            border: none;
            padding: 12px;
            border-radius: 8px;
            width: 100%;
            cursor: pointer;
            font-size: 0.75rem;
            font-weight: 700;
            text-transform: uppercase;
            transition: 0.2s;
        }

        .btn-primary:active {
            transform: scale(0.98);
        }

        .btn-control {
            background: #1e293b;
            color: #fff;
            border: 1px solid #334155;
            padding: 10px;
            border-radius: 8px;
            width: 100%;
            font-size: 0.75rem;
            margin-bottom: 5px;
        }

        .game-info {
            width: 100%;
            max-width: 450px;
            background: rgba(15, 23, 42, 0.5);
            padding: 10px;
            border-radius: 10px;
            display: flex;
            gap: 10px;
            align-items: center;
        }

        .eval-bar-wrap {
            width: 8px;
            background: #000;
            border-radius: 4px;
            overflow: hidden;
            position: relative;
            flex-shrink: 0;
        }

        .eval-bar-fill {
            position: absolute;
            bottom: 0;
            width: 100%;
            background: white;
            height: 50%;
            transition: 0.4s;
        }

        /* DESKTOP LAYOUT */
        @media (min-width: 900px) {
            .app-container {
                flex-direction: row;
                justify-content: center;
                align-items: flex-start;
                gap: 16px;
                padding: 20px;
            }

            .sidebar-left {
                width: 180px;
                flex-shrink: 0;
            }

            .mode-selectors {
                grid-template-columns: 1fr;
                gap: 10px;
            }

            .mode-pill {
                flex-direction: row;
                gap: 12px;
                justify-content: flex-start;
                padding-left: 20px;
            }

            .game-zone {
                width: 500px;
                flex-shrink: 0;
            }

            #myBoard {
                width: 500px;
                max-width: 500px;
            }

            .sidebar-right {
                width: 280px;
                flex-shrink: 0;
            }
        }

        /* Maestro IA Styles */
        .master-panel {
            background: rgba(30, 41, 59, 0.9);
            border-left: 4px solid var(--accent);
            border-radius: 8px;
            padding: 12px;
            margin-top: 5px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.3);
            display: flex;
            gap: 12px;
            align-items: flex-start;
            width: 100%;
            max-width: 450px;
        }

        .master-avatar {
            width: 40px;
            height: 40px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
            flex-shrink: 0;
            box-shadow: var(--neon-glow);
        }

        .master-content {
            flex: 1;
        }

        .master-header {
            font-size: 0.65rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            color: var(--accent);
            font-weight: 800;
            margin-bottom: 4px;
        }

        .master-text {
            font-size: 0.8rem;
            line-height: 1.4;
            color: var(--text-main);
        }

        .quality-excellent {
            color: #22c55e;
            font-weight: bold;
        }

        .quality-dubious {
            color: #f59e0b;
            font-weight: bold;
        }

        .quality-blunder {
            color: #ef4444;
            font-weight: bold;
        }

        .trap-warning {
            color: var(--trap-color);
            font-weight: 800;
            animation: pulse 2s infinite;
            display: block;
            margin-top: 5px;
            font-size: 0.75rem;
        }

        .best-move-box {
            background: rgba(59, 130, 246, 0.15);
            border: 1px solid #3b82f6;
            color: #3b82f6;
            padding: 6px;
            border-radius: 6px;
            font-size: 0.75rem;
            font-weight: 700;
            text-align: center;
            margin-top: 8px;
            display: none;
        }

        .legal-dot {
            width: 18px;
            height: 18px;
            background: rgba(34, 197, 94, 0.4);
            border-radius: 50%;
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            pointer-events: none;
            z-index: 50;
        }

        .highlight-selected {
            background: rgba(34, 197, 94, 0.5) !important;
        }

        .highlight-hint {
            box-shadow: inset 0 0 0 4px #3b82f6 !important;
        }

        #side-drawer {
            position: fixed;
            top: 0;
            left: -280px;
            width: 280px;
            height: 100vh;
            background: rgba(15, 23, 42, 0.98);
            z-index: 2000;
            transition: 0.3s ease;
            box-shadow: 5px 0 25px rgba(0, 0, 0, 0.5);
            padding: 25px;
            display: flex;
            flex-direction: column;
        }

        #side-drawer.open {
            left: 0;
        }

        #side-drawer-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background: rgba(0, 0, 0, 0.6);
            z-index: 1999;
            display: none;
            backdrop-filter: blur(2px);
        }

        .label-tiny {
            font-size: 0.6rem;
            color: var(--text-muted);
            font-weight: 800;
            margin-bottom: 5px;
            display: block;
            text-transform: uppercase;
        }

        .tool-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 8px;
            margin-top: 8px;
        }

        .btn-tool {
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            font-size: 0.65rem;
            padding: 10px;
            border-radius: 8px;
            cursor: pointer;
            font-weight: 700;
        }

        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            z-index: 3000;
            display: none;
            align-items: center;
            justify-content: center;
            backdrop-filter: blur(5px);
        }

        .modal-card {
            background: #1e293b;
            padding: 30px;
            border-radius: 16px;
            border: 1px solid var(--accent);
            width: 90%;
            max-width: 400px;
            box-shadow: 0 0 30px rgba(0, 0, 0, 0.5);
        }

        .modal-card h3 {
            margin-bottom: 20px;
            color: var(--accent);
            text-align: center;
        }

        .input-group {
            margin-bottom: 15px;
        }

        .input-group label {
            display: block;
            font-size: 0.7rem;
            color: var(--text-muted);
            margin-bottom: 5px;
        }

        .input-group input {
            width: 100%;
            padding: 12px;
            background: rgba(0, 0, 0, 0.2);
            border: 1px solid #334155;
            border-radius: 8px;
            color: white;
            outline: none;
        }

        .input-group input:focus {
            border-color: var(--accent);
        }

        @keyframes pulse {
            0% {
                opacity: 0.7;
            }

            50% {
                opacity: 1;
            }

            100% {
                opacity: 0.7;
            }
        }

        /* TIMER STYLES */
        .timer-box {
            background: #1e293b;
            color: #fff;
            padding: 5px 12px;
            border-radius: 6px;
            font-family: 'Courier New', Courier, monospace;
            font-weight: 700;
            font-size: 1.1rem;
            min-width: 80px;
            text-align: center;
            border: 2px solid #334155;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.3);
        }

        .timer-box.active {
            border-color: var(--accent);
            color: var(--accent);
            box-shadow: var(--neon-glow);
        }

        .timer-box.low-time {
            border-color: #ef4444;
            color: #ef4444;
            animation: pulse 0.5s infinite;
        }

        .player-info {
            width: 100%;
            max-width: 450px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 5px 10px;
            background: rgba(30, 41, 59, 0.4);
            border-radius: 8px;
            margin: 2px 0;
        }

        .time-selector-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 6px;
            margin-bottom: 10px;
        }

        .time-btn {
            background: #1e293b;
            border: 1px solid #334155;
            color: #94a3b8;
            padding: 8px;
            border-radius: 6px;
            font-size: 0.65rem;
            cursor: pointer;
            font-weight: 700;
        }

        .time-btn.active {
            border-color: var(--accent);
            color: var(--accent);
            background: rgba(34, 197, 94, 0.1);
        }

        /* NAVIGATION BUTTONS */
        .nav-toolbar {
            display: flex;
            justify-content: center;
            gap: 10px;
            margin: 10px 0;
            width: 100%;
            max-width: 450px;
        }

        .btn-nav {
            background: #1e293b;
            border: 1px solid #334155;
            color: #fff;
            padding: 8px 12px;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            flex: 1;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* TABS SYSTEM */
        .sidebar-tabs {
            display: flex;
            background: rgba(15, 23, 42, 0.4);
            border-radius: 12px 12px 0 0;
            overflow: hidden;
            border: 1px solid rgba(255, 255, 255, 0.05);
            margin-top: 10px;
        }

        .tab-btn {
            flex: 1;
            padding: 12px;
            font-size: 0.65rem;
            font-weight: 700;
            color: var(--text-muted);
            background: transparent;
            border: none;
            cursor: pointer;
            transition: 0.3s;
            text-transform: uppercase;
            letter-spacing: 1px;
        }

        .tab-btn.active {
            color: var(--accent);
            background: rgba(34, 197, 94, 0.1);
            border-bottom: 2px solid var(--accent);
        }

        .tab-content {
            display: none;
            background: rgba(15, 23, 42, 0.3);
            border: 1px solid rgba(255, 255, 255, 0.05);
            border-top: none;
            padding: 15px;
            border-radius: 0 0 12px 12px;
            height: 400px;
            /* Fixed height for consistency */
            overflow-y: auto;
        }

        .tab-content.active {
            display: flex;
            flex-direction: column;
        }

        /* RANKING STYLES */
        .ranking-list {
            display: flex;
            flex-direction: column;
            gap: 8px;
        }

        .ranking-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: rgba(255, 255, 255, 0.03);
            border-radius: 8px;
            font-size: 0.75rem;
            transition: 0.3s;
        }

        .ranking-item:hover {
            background: rgba(34, 197, 94, 0.05);
        }

        .rank-num {
            width: 25px;
            height: 25px;
            background: var(--accent);
            color: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 800;
            font-size: 0.6rem;
        }

        .rank-top1 {
            background: gold;
            color: #000;
            box-shadow: 0 0 10px gold;
        }

        .rank-top2 {
            background: silver;
            color: #000;
        }

        .rank-top3 {
            background: #cd7f32;
            color: #fff;
        }

        /* HISTORY STYLES */
        .history-item {
            background: rgba(30, 41, 59, 0.5);
            border-radius: 8px;
            padding: 10px;
            cursor: pointer;
            transition: 0.2s;
            border: 1px solid rgba(255, 255, 255, 0.05);
        }

        .history-item:hover {
            border-color: var(--accent);
            background: rgba(34, 197, 94, 0.05);
        }

        .hist-date {
            font-size: 0.6rem;
            color: var(--text-muted);
            margin-bottom: 4px;
        }

        .hist-main {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .hist-players {
            font-size: 0.75rem;
            font-weight: 700;
            color: var(--text-main);
        }

        .hist-result {
            font-size: 0.7rem;
            font-weight: 800;
            padding: 2px 6px;
            border-radius: 4px;
        }

        .res-win {
            background: rgba(34, 197, 94, 0.2);
            color: var(--accent);
        }

        .res-lose {
            background: rgba(239, 68, 68, 0.2);
            color: #ef4444;
        }

        .res-draw {
            background: rgba(148, 163, 184, 0.2);
            color: var(--text-muted);
        }

        .btn-nav:hover {
            background: #334155;
            border-color: var(--accent);
        }

        .btn-emoji {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 6px;
            padding: 5px 8px;
            cursor: pointer;
            font-size: 1rem;
            transition: 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .btn-emoji:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: scale(1.1);
            border-color: var(--accent);
        }

        /* OVERLAYS */
        #game-overlay {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            display: none;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 100;
            border-radius: 6px;
            animation: fadeIn 0.5s ease;
        }

        #game-overlay h2 {
            color: var(--accent);
            font-size: 2.5rem;
            text-shadow: 0 0 20px var(--accent);
            margin-bottom: 20px;
        }

        .quality-excellent {
            color: #22c55e !important;
            font-weight: bold;
        }

        .quality-dubious {
            color: #f59e0b !important;
            font-weight: bold;
        }

        .quality-blunder {
            color: #ef4444 !important;
            font-weight: bold;
        }

        /* CHAT STYLES */
        .chat-container {
            margin-top: 15px;
            background: rgba(0, 0, 0, 0.3);
            border-radius: 12px;
            border: 1px solid #334155;
            display: flex;
            flex-direction: column;
            overflow: hidden;
            height: 250px;
        }

        .chat-messages {
            flex: 1;
            overflow-y: auto;
            padding: 10px;
            font-size: 0.75rem;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .chat-msg {
            padding: 6px 10px;
            border-radius: 8px;
            max-width: 85%;
            word-wrap: break-word;
        }

        .chat-msg.mine {
            align-self: flex-end;
            background: var(--accent);
            color: white;
        }

        .chat-msg.other {
            align-self: flex-start;
            background: #1e293b;
            color: var(--text-main);
            border: 1px solid #334155;
        }

        .chat-input-wrap {
            display: flex;
            padding: 8px;
            background: rgba(0, 0, 0, 0.2);
            gap: 5px;
        }

        .chat-input {
            flex: 1;
            background: transparent;
            border: 1px solid #334155;
            border-radius: 6px;
            padding: 5px 10px;
            color: white;
            font-size: 0.75rem;
            outline: none;
        }

        .chat-input:focus {
            border-color: var(--accent);
        }
    </style>
</head>

<body>
    <div class="app-header">
        <div style="display:flex; align-items:center; gap:12px;">
            <div id="hamburger-menu" style="cursor:pointer; font-size:1.4rem; color:var(--accent);">‚ò∞</div>
            <div class="logo-inline">
                <h1>CHESS <span style="color:var(--accent)">PRO</span></h1>
            </div>
        </div>
        <div id="header-user-info" style="display:flex; align-items:center; gap:10px;">
            <div id="header-elo" title="ELO Partidas"
                style="background:rgba(34, 197, 94, 0.1); border:1px solid var(--accent); color:var(--accent); padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:700;">
                500 ELO</div>
            <div id="header-elo-puz" title="ELO Puzzles"
                style="background:rgba(59, 130, 246, 0.1); border:1px solid #3b82f6; color:#3b82f6; padding:2px 8px; border-radius:4px; font-size:0.7rem; font-weight:700;">
                500üß©</div>
            <div id="btn-auth-trigger" style="cursor:pointer; font-size:0.8rem; color:var(--text-muted);">üë§ Acceder
            </div>
        </div>
    </div>

    <!-- MODALES AUTH -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-card">
            <h3 id="auth-title">INICIAR SESI√ìN</h3>
            <div class="input-group">
                <label>USUARIO</label>
                <input type="text" id="auth-user" placeholder="Tu nombre...">
            </div>
            <div class="input-group" id="reg-group" style="display:none;">
                <label>EMAIL</label>
                <input type="email" id="auth-email" placeholder="correo@ejemplo.com">
            </div>
            <div class="input-group">
                <label>CONTRASE√ëA</label>
                <input type="password" id="auth-pass" placeholder="******">
            </div>
            <button class="btn-primary" id="btn-auth-submit">ENTRAR</button>
            <p id="auth-switch"
                style="font-size:0.7rem; text-align:center; margin-top:15px; cursor:pointer; color:var(--text-muted);">
                ¬øNo tienes cuenta? <span style="color:var(--accent)">Reg√≠strate</span></p>
            <button class="btn-tool" id="btn-auth-close" style="width:100%; margin-top:10px;">CERRAR</button>
        </div>
    </div>

    <div id="side-drawer-overlay"></div>
    <div id="side-drawer">
        <div class="drawer-section" style="margin-bottom:20px;">
            <label class="label-tiny" id="lbl-user">üë§ USUARIO</label>
            <div id="drawer-user-card"
                style="background:rgba(255,255,255,0.05); padding:15px; border-radius:12px; display:flex; flex-direction:column; gap:8px;">
                <div id="drawer-user-name" style="font-weight:700; color:var(--accent);">Invitado</div>
                <div id="drawer-user-elo" style="font-size:0.7rem; color:var(--text-muted);">ELO: 500</div>
                <button class="btn-primary" id="btn-auth-drawer" style="padding:8px; font-size:0.65rem;">ACCEDER /
                    REGISTRO</button>
            </div>
        </div>

        <div class="drawer-section" style="margin-bottom:20px;">
            <label class="label-tiny" id="lbl-appearance">üé® APARIENCIA</label>
            <div style="margin-bottom:10px;">
                <label style="font-size:0.6rem; color:var(--text-muted);" id="lbl-board">Tablero</label>
                <select class="btn-control" id="board-theme-sel">
                    <option value="classic">Cl√°sico (Azul)</option>
                    <option value="wood">Madera</option>
                    <option value="neon">Neon Dark</option>
                    <option value="forest">Bosque</option>
                </select>
            </div>
            <div>
                <label style="font-size:0.6rem; color:var(--text-muted);" id="lbl-pieces">Piezas</label>
                <select class="btn-control" id="piece-theme-sel">
                    <option value="wikipedia">Wikipedia</option>
                    <option value="alpha">Alpha</option>
                    <option value="uscf">USCF</option>
                </select>
            </div>
        </div>

        <div class="drawer-section" style="margin-bottom:20px;">
            <label class="label-tiny" id="lbl-lang">üåê IDIOMA / LANGUAGE</label>
            <select class="btn-control" id="lang-sel">
                <option value="es">Espa√±ol</option>
                <option value="en">English</option>
            </select>
        </div>

        <div class="drawer-item" id="btn-toggle-sound"
            style="cursor:pointer; padding:10px 0; border-bottom:1px solid rgba(255,255,255,0.05);">üîä Sonidos: ON</div>
        <div style="margin-top:auto; font-size:0.6rem; color:var(--text-muted);">V 2.5 - Cloud Edition</div>
    </div>

    <div class="app-container">
        <aside class="sidebar-left">
            <div class="mode-selectors">
                <div class="mode-pill active" data-mode="local"><span>üåê</span><span>Online</span></div>
                <div class="mode-pill" data-mode="ai"><span>ü§ñ</span><span>Vs IA</span></div>
                <div class="mode-pill" data-mode="study"><span>üìö</span><span>Estudio</span></div>
                <div class="mode-pill" data-mode="exercises"><span>üß©</span><span>Puzzles</span></div>
            </div>
            <button class="btn-primary" id="btn-flip" style="margin-top:8px;">GIRAR TABLERO</button>
        </aside>

        <div class="game-zone">
            <!-- TIMER OPONENTE -->
            <div class="player-info" id="p-top">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div id="opp-avatar" style="font-size:1.2rem;">üë§</div>
                    <span id="opp-name" style="font-size:0.8rem; font-weight:700;">Oponente</span>
                </div>
                <div id="opp-timer" class="timer-box">10:00</div>
            </div>

            <div style="position:relative; width:100%; max-width:450px;">
                <div id="myBoard"></div>
                <div id="game-overlay"
                    style="position:absolute; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.85); display:none; flex-direction:column; align-items:center; justify-content:center; z-index:999; border-radius:4px; transition:0.3s;">
                    <h2 id="overlay-msg"
                        style="color:var(--accent); text-shadow:0 0 15px var(--accent); margin-bottom:20px; font-size:2rem;">
                        JAQUE MATE</h2>
                    <button class="btn-primary" onclick="$('#game-overlay').fadeOut()"
                        style="width:auto; padding:10px 25px;">CERRAR</button>
                </div>
            </div>

            <!-- CONTROLES DE NAVEGACI√ìN -->
            <div class="nav-toolbar">
                <button class="btn-nav" id="btn-nav-first" title="Inicio">‚èÆ</button>
                <button class="btn-nav" id="btn-nav-prev" title="Anterior">‚óÄ</button>
                <button class="btn-nav" id="btn-nav-next" title="Siguiente">‚ñ∂</button>
                <button class="btn-nav" id="btn-nav-last" title="Fin">‚è≠</button>
            </div>

            <!-- TIMER JUGADOR -->
            <div class="player-info" id="p-bottom">
                <div style="display:flex; align-items:center; gap:8px;">
                    <div id="my-avatar" style="font-size:1.2rem;">üë§</div>
                    <span id="my-name-display" style="font-size:0.8rem; font-weight:700;">Invitado</span>
                </div>
                <div id="my-timer" class="timer-box">10:00</div>
            </div>

            <div class="master-panel" id="master-coach-panel">
                <div class="master-avatar">üë¥</div>
                <div class="master-content">
                    <div class="master-header">Maestro de Ajedrez IA</div>
                    <div id="coach-txt" class="master-text">
                        Bienvenido. Juega una partida o analiza una posici√≥n para recibir mis consejos.
                    </div>
                    <div id="best-move-display" class="best-move-box">Mejor jugada: e2e4</div>
                </div>
                <div class="eval-bar-wrap" style="height: 100px; width: 6px;">
                    <div class="eval-bar-fill" id="eval-fill-master" style="height:50%;"></div>
                </div>
            </div>
        </div>

        <aside class="sidebar-right">
            <div class="sidebar-tabs">
                <button class="tab-btn active" data-tab="tab-play">‚öôÔ∏è JUEGO</button>
                <button class="tab-btn" data-tab="tab-chat">üí¨ CHAT</button>
                <button class="tab-btn" data-tab="tab-history">üìú HISTORIAL</button>
                <button class="tab-btn" data-tab="tab-ranking">üèÜ RANKING</button>
            </div>

            <!-- TAB: JUEGO -->
            <div class="tab-content active" id="tab-play">
                <!-- MODO LOCAL / ONLINE -->
                <div class="mode-section active" id="sec-local">
                    <label class="label-tiny">TIEMPO DE JUEGO</label>
                    <div class="time-selector-grid" id="local-time-selector">
                        <button class="time-btn" data-time="1">1 min</button>
                        <button class="time-btn" data-time="3">3 min</button>
                        <button class="time-btn active" data-time="10">10 min</button>
                        <button class="time-btn" data-time="30">30 min</button>
                        <button class="time-btn" data-time="1440">24h</button>
                    </div>
                    <label class="label-tiny">SALA DE JUEGO</label>
                    <div id="challenges-list"
                        style="max-height:150px; overflow-y:auto; background:rgba(0,0,0,0.2); border-radius:8px; margin-bottom:10px; padding:5px;">
                        <div style="font-size:0.65rem; color:var(--text-muted); text-align:center; padding:10px;">
                            Buscando retos...</div>
                    </div>
                    <button class="btn-primary" id="btn-create">‚öîÔ∏è CREAR RETO</button>
                    <div style="display:flex; gap:5px; margin-top:5px;">
                        <button class="btn-danger" id="btn-abort" style="flex:1;">ABORTAR</button>
                        <button class="btn-danger" id="btn-resign-local" style="flex:1;">RENDIRSE</button>
                    </div>
                    <button class="btn-tool" id="btn-analyze-game"
                        style="width:100%; margin-top:10px; border-color:var(--accent); color:var(--text-main);">üîç
                        ANALIZAR PARTIDA</button>
                </div>

                <!-- MODO IA -->
                <div class="mode-section" id="sec-ai">
                    <label class="label-tiny">TIEMPO DE JUEGO</label>
                    <div class="time-selector-grid" id="ai-time-selector">
                        <button class="time-btn" data-time="1">1 min</button>
                        <button class="time-btn" data-time="3">3 min</button>
                        <button class="time-btn active" data-time="10">10 min</button>
                    </div>
                    <label class="label-tiny">DIFICULTAD DE LA IA</label>
                    <select class="btn-control" id="diff-sel">
                        <option value="1">Nivel 1 (ELO 500)</option>
                        <option value="3">Nivel 3 (ELO 800)</option>
                        <option value="5">Nivel 5 (ELO 1100)</option>
                        <option value="8">Nivel 8 (ELO 1400)</option>
                        <option value="10" selected>Nivel 10 (ELO 1700)</option>
                        <option value="15">Nivel 15 (ELO 2100)</option>
                        <option value="20">Nivel 20 (ELO 2500+)</option>
                    </select>
                    <button class="btn-primary" id="btn-start-ai">EMPEZAR PARTIDA</button>
                    <button class="btn-danger" id="btn-resign-ai" style="margin-top:5px;">RENDIRSE</button>
                    <button class="btn-tool" id="btn-ai-hint" style="width:100%; margin-top:8px;">üí° ACTIVAR
                        PISTAS</button>
                </div>

                <!-- MODO ESTUDIO -->
                <div class="mode-section" id="sec-study">
                    <label class="label-tiny">BIBLIOTECA DE APERTURAS</label>
                    <select class="btn-control" id="opening-sel">
                        <option value="">-- Seleccionar --</option>
                    </select>
                    <div class="tool-grid">
                        <button class="btn-tool" onclick="game.reset(); board.start(); updateUI();">üîÑ RESET</button>
                        <button class="btn-tool" id="btn-pgn">üìÇ PGN</button>
                        <button class="btn-tool" id="btn-editor">‚õèÔ∏è EDITOR</button>
                        <button class="btn-tool" onclick="alert(game.fen())">üìã FEN</button>
                    </div>
                </div>

                <!-- MODO PUZZLES -->
                <div class="mode-section" id="sec-exercises">
                    <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                        <label class="label-tiny" style="margin:0;">CATEGOR√çA</label>
                        <div id="puz-timer"
                            style="color:var(--accent); font-weight:800; font-family:monospace; font-size:1rem;">00:00
                        </div>
                    </div>
                    <select class="btn-control" id="puz-cat-sel">
                        <option value="all">Todos los puzzles</option>
                        <option value="opening">Aperturas</option>
                        <option value="middlegame">Juego Medio</option>
                        <option value="endgame">Finales</option>
                    </select>
                    <div
                        style="background:rgba(0,0,0,0.2); padding:12px; border-radius:10px; margin-bottom:10px; margin-top:8px;">
                        <div
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:8px;">
                            <h4 style="color:var(--accent); font-size:0.8rem;">Resolver</h4>
                            <span id="puz-elo-display" style="font-size:0.6rem; color:#3b82f6; font-weight:800;">ELO
                                PUZ: 500</span>
                        </div>
                        <p id="puz-desc" style="font-size:0.7rem; color:var(--text-main); line-height:1.4;">Cargando
                            puzzle...</p>
                    </div>
                    <div class="tool-grid" style="margin-bottom:10px;">
                        <button class="btn-primary" id="btn-next-puz" style="padding:10px;">SALTAR</button>
                        <button class="btn-tool" id="btn-puz-hint" style="color:var(--accent);">Pista üí°</button>
                        <button class="btn-tool" id="btn-show-sol"
                            style="grid-column: span 2; border-color:#3b82f6;">Ver Soluci√≥n üëÄ</button>
                    </div>
                </div>
            </div>

            <!-- TAB: CHAT -->
            <div class="tab-content" id="tab-chat">
                <div class="chat-container" style="height:100%; border:none; background:transparent; margin-top:0;">
                    <div class="chat-messages" id="chat-msgs" style="background:rgba(0,0,0,0.1); border-radius:8px;">
                        <div style="color:var(--text-muted); text-align:center; margin:auto; font-size:0.65rem;">
                            Bienvenido al chat global</div>
                    </div>
                    <div id="emoji-bar"
                        style="display:flex; gap:8px; padding:5px; flex-wrap:wrap; justify-content:center;">
                        <button class="btn-emoji" data-emoji="üòÄ">üòÄ</button>
                        <button class="btn-emoji" data-emoji="üî•">üî•</button>
                        <button class="btn-emoji" data-emoji="üëè">üëè</button>
                        <button class="btn-emoji" data-emoji="üòÆ">üòÆ</button>
                        <button class="btn-emoji" data-emoji="ü§ù">ü§ù</button>
                        <button class="btn-emoji" data-emoji="üíÄ">üíÄ</button>
                        <button class="btn-emoji" data-emoji="‚≠ê">‚≠ê</button>
                    </div>
                    <div class="chat-input-wrap" style="margin-top:5px;">
                        <input type="text" id="chat-input" class="chat-input" placeholder="Mensaje...">
                        <button id="btn-chat-send"
                            style="background:var(--accent); border:none; color:white; padding:5px 12px; border-radius:6px; cursor:pointer; font-size:0.75rem;">ENVIAR</button>
                    </div>
                </div>
            </div>

            <!-- TAB: RANKING -->
            <div class="tab-content" id="tab-ranking">
                <label class="label-tiny">TOP 10 MUNDIAL</label>
                <div class="ranking-list" id="global-ranking">
                    <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.7rem;">Cargando
                        jugadores...</div>
                </div>
            </div>

            <!-- TAB: HISTORIAL -->
            <div class="tab-content" id="tab-history">
                <label class="label-tiny">MIS PARTIDAS RECIENTES</label>
                <div id="history-list" style="display:flex; flex-direction:column; gap:8px;">
                    <div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.7rem;">No hay
                        partidas guardadas.</div>
                </div>
            </div>
        </aside>
    </div>

    <script>
        const OPENINGS_DATA = [
            {
                group: "Aperturas", items: [
                    { name: "Espa√±ola", m: ["e4", "e5", "Nf3", "Nc6", "Bb5"] },
                    { name: "Gambito de Dama", m: ["d4", "d5", "c4"] },
                    { name: "Siciliana", m: ["e4", "c5"] },
                    { name: "Mate del Pastor", m: ["e4", "e5", "Qh5", "Nc6", "Bc4", "Nf6", "Qxf7#"], trap: "Mate r√°pido en f7 si las negras no se defienden." }
                ]
            }
        ];

        const PUZZLES_DB = [
            { cat: "opening", fen: "r1bqkb1r/pppp1ppp/2n2n2/4p2Q/2B1P3/8/PPPP1PPP/RNB1K1NR w KQkq - 4 4", sol: ["h5f7"], desc: "Encuentra el Mate del Pastor." },
            { cat: "middlegame", fen: "4r1k1/5ppp/8/8/8/8/Q7/6K1 w - - 0 1", sol: ["a2a8"], desc: "Encuentra el mate del pasillo." },
            { cat: "middlegame", fen: "r1b2rk1/pp3ppp/2n5/2p5/2B5/5Q2/PPP2PPP/R1B1R1K1 w - - 0 1", sol: ["f3f7", "r8f7", "e1e8"], desc: "Aprovecha la debilidad de la octava fila." },
            { cat: "endgame", fen: "8/8/8/k7/8/1Q6/1K6/8 w - - 0 1", sol: ["b3b5"], desc: "Mate en una con la Dama." },
            { cat: "endgame", fen: "4k3/8/4K3/Q7/8/8/8/8 w - - 0 1", sol: ["a5a8"], desc: "Mate de carril con la Dama." },
            { cat: "opening", fen: "rn1qkbnr/pppb1ppp/4p3/1B1p4/3PP3/8/PPP2PPP/RNBQK1NR w KQkq - 2 4", sol: ["e4d5"], desc: "Mejor captura en el centro." }
        ];

        var game = new Chess();
        var board = null;
        var socket = io(); // Connect to server
        var gameId = null;
        var currentMode = 'local'; // Default mode
        var selectedSq = null;
        var showHints = false;
        var isJ = false;
        var lastEv = 0;
        var stockfish = null;
        var myColor = 'w';

        // TIMER VARIABLES
        var whiteTime = 600; // default 10m
        var blackTime = 600;
        var clockInterval = null;
        var gameStarted = false;

        // PUZZLE TIMER
        var puzSeconds = 0;
        var puzTimerInterval = null;

        var currentPuzzle = null;
        var puzzleStep = 0;
        var userPuzzleElo = parseInt(localStorage.getItem('chess_puz_elo')) || 500;

        // SISTEMA ELO & AUTH
        var userElo = parseInt(localStorage.getItem('chess_user_elo')) || 500;
        var userName = localStorage.getItem('chess_username') || "Invitado";
        var isAuth = localStorage.getItem('chess_is_auth') === 'true';

        // SOUND SYSTEM
        var soundOn = localStorage.getItem('chess_sound') !== 'false';
        const sounds = {
            move: new Audio('https://github.com/lichess-org/lila/raw/master/public/sound/standard/Move.mp3'),
            capture: new Audio('https://github.com/lichess-org/lila/raw/master/public/sound/standard/Capture.mp3'),
            check: new Audio('https://github.com/lichess-org/lila/raw/master/public/sound/standard/Check.mp3'),
            end: new Audio('https://github.com/lichess-org/lila/raw/master/public/sound/standard/GenericNotify.mp3'),
            error: new Audio('https://github.com/lichess-org/lila/raw/master/public/sound/standard/Error.mp3')
        };
        function playSnd(s) { if (soundOn && sounds[s]) sounds[s].play().catch(e => { }); }

        var historyPositions = ['start'];
        var currentHistoryIndex = 0;
        var moveHistory = []; // Logic for analysis {fen, move, cp, diff, quality}
        var analysisActive = false;

        // MULTI-LANGUAGE SUPPORT
        var currentLang = localStorage.getItem('chess_lang') || 'es';
        const LANGS = {
            es: {
                mate: "JAQUE MATE", win: "¬°HAS GANADO!", lose: "HAS PERDIDO", draw: "TABLAS",
                resign: "¬øEst√°s seguro de que quieres rendirte?", abort: "¬øAbortar partida? No perder√°s ELO.",
                guest: "Invitado", login: "INICIAR SESI√ìN", logout: "CERRAR SESI√ìN",
                puz_done: "¬°EXCELENTE!", puz_hint: "Analiza bien la posici√≥n...",
                best_move: "Mejor jugada", level: "Nivel", diff: "Dificultad", theme: "Temas",
                brilliant: "¬°ESPECTACULAR!", great: "¬°Muy buena!", best: "Mejor jugada",
                good: "Buena", inaccuracy: "Imprecisi√≥n", mistake: "Error", blunder: "ERROR GRAVE"
            },
            en: {
                mate: "CHECKMATE", win: "YOU WON!", lose: "YOU LOST", draw: "DRAW",
                resign: "Are you sure you want to resign?", abort: "Abort game? You won't lose ELO.",
                guest: "Guest", login: "LOGIN", logout: "LOGOUT",
                puz_done: "EXCELLENT!", puz_hint: "Analyze the position carefully...",
                best_move: "Best move", level: "Level", diff: "Difficulty", theme: "Themes",
                brilliant: "BRILLIANT!", great: "Great find!", best: "Best move",
                good: "Good", inaccuracy: "Inaccuracy", mistake: "Mistake", blunder: "BLUNDER"
            }
        };

        function getQualityMsg(diff, isMate) {
            const t = LANGS[currentLang];
            if (isMate) return { text: t.mate, class: 'quality-excellent' };
            if (diff < 0.1) return { text: t.best, class: 'quality-excellent' };
            if (diff < 0.3) return { text: t.good, class: 'quality-excellent' };
            if (diff < 0.7) return { text: t.inaccuracy, class: 'quality-dubious' };
            if (diff < 1.5) return { text: t.mistake, class: 'quality-dubious' };
            return { text: t.blunder, class: 'quality-blunder' };
        }

        function setLanguage(l) {
            currentLang = l;
            localStorage.setItem('chess_lang', l);
            const t = LANGS[l];
            $('#auth-title').text(t.login);
            if (!isAuth) {
                $('#my-name-display').text(t.guest);
                $('#drawer-user-name').text(t.guest);
            }
            $('#lbl-user').text(l === 'es' ? "üë§ USUARIO" : "üë§ USER");
            $('#lbl-appearance').text(l === 'es' ? "üé® APARIENCIA" : "üé® APPEARANCE");
            $('#lbl-board').text(l === 'es' ? "Tablero" : "Board");
            $('#lbl-pieces').text(l === 'es' ? "Piezas" : "Pieces");
            $('#lbl-lang').text(l === 'es' ? "üåê IDIOMA" : "üåê LANGUAGE");
            $('#btn-flip').text(l === 'es' ? "GIRAR TABLERO" : "FLIP BOARD");
            $('#btn-abort').text(l === 'es' ? "ABORTAR" : "ABORT");
            $('#btn-resign-ai, #btn-resign-local').text(l === 'es' ? "RENDIRSE" : "RESIGN");
            $('#btn-start-ai').text(l === 'es' ? "EMPEZAR PARTIDA" : "START GAME");
        }

        function formatTime(s) {
            if (s < 0) s = 0;
            const h = Math.floor(s / 3600);
            const m = Math.floor((s % 3600) / 60);
            const sec = s % 60;
            if (h > 0) {
                return h + ":" + (m < 10 ? "0" : "") + m + ":" + (sec < 10 ? "0" : "") + sec;
            }
            return (m < 10 ? "0" : "") + m + ":" + (sec < 10 ? "0" : "") + sec;
        }

        function stopClock() {
            clearInterval(clockInterval);
            clockInterval = null;
            $('.timer-box').removeClass('active');
        }

        function startClock() {
            if (clockInterval) clearInterval(clockInterval);
            gameStarted = true;
            clockInterval = setInterval(() => {
                if (game.turn() === 'w') {
                    whiteTime--;
                    $('#my-timer').text(formatTime(whiteTime));
                    if (whiteTime <= 30) $('#my-timer').addClass('low-time');
                    if (whiteTime <= 0) endGameByTime('w');
                } else {
                    blackTime--;
                    $('#opp-timer').text(formatTime(blackTime));
                    if (blackTime <= 30) $('#opp-timer').addClass('low-time');
                    if (blackTime <= 0) endGameByTime('b');
                }
                updateTimerVisuals();
            }, 1000);
        }

        function updateTimerVisuals() {
            $('.timer-box').removeClass('active');
            if (game.turn() === 'w') $('#my-timer').addClass('active');
            else $('#opp-timer').addClass('active');
        }

        function endGameByTime(loser) {
            stopClock();
            const winner = loser === 'w' ? 'Negras' : 'Blancas';
            alert(`¬°TIEMPO AGOTADO! Ganan las ${winner}`);
            checkGameOver(); // handles elo
        }

        function updateElo(opponentElo, result, isPuzzle = false) {
            const k = 32;
            const currentElo = isPuzzle ? userPuzzleElo : userElo;
            const expectedScore = 1 / (1 + Math.pow(10, (opponentElo - currentElo) / 400));
            const newElo = Math.round(currentElo + k * (result - expectedScore));

            if (isPuzzle) {
                userPuzzleElo = Math.max(100, newElo);
                localStorage.setItem('chess_puz_elo', userPuzzleElo);
                $('#header-elo-puz, #puz-elo-display').text(userPuzzleElo + (isPuzzle ? "üß©" : ""));
            } else {
                userElo = Math.max(100, newElo);
                localStorage.setItem('chess_user_elo', userElo);
                $('#header-elo').text(userElo + " ELO");
            }

            // Sync with Server (Global ELO)
            if (isAuth) {
                socket.emit('update_elo', {
                    user: userName,
                    elo: userElo,
                    puzElo: userPuzzleElo
                });
            }

            $('#coach-txt').append(`<br><b style="color:var(--accent)">${isPuzzle ? 'Puzzle ELO' : 'ELO'}: ${newElo}</b>`);
        }

        var solvedPuzzles = JSON.parse(localStorage.getItem('chess_solved_puzzles') || '[]');

        function loadLocalPuzzle() {
            const cat = $('#puz-cat-sel').val();
            const filtered = cat === 'all' ? PUZZLES_DB : PUZZLES_DB.filter(p => p.cat === cat);
            if (filtered.length === 0) {
                $('#puz-desc').text("No hay puzzles locales en esta categor√≠a.");
                return;
            }
            currentPuzzle = filtered[Math.floor(Math.random() * filtered.length)];
            puzzleStep = 0;
            game.load(currentPuzzle.fen);
            board.position(currentPuzzle.fen);
            $('#puz-desc').text(currentPuzzle.desc);
            updateUI();
        }

        async function loadRandomPuzzle(retryCount = 0) {
            const cat = $('#puz-cat-sel').val();
            const themesPool = ['fork', 'pin', 'skewer', 'sacrifice', 'mate', 'mateIn2', 'mateIn1', 'advantage', 'crushing', 'opening', 'middlegame', 'endgame'];

            if (retryCount === 0) {
                clearInterval(puzTimerInterval);
                puzSeconds = 0;
                $('#puz-timer').text("00:00").css('color', 'var(--accent)');
                puzTimerInterval = setInterval(() => {
                    puzSeconds++;
                    $('#puz-timer').text(formatTime(puzSeconds));
                }, 1000);
            }

            if (retryCount > 6) {
                $('#puz-desc').html("<b style='color:#ef4444'>‚ùå Error: La base de datos no responde.</b><br>Int√©ntalo de nuevo en unos segundos.");
                return;
            }

            const r = 800 + Math.floor(Math.random() * 1500);
            let theme = cat;
            if (cat === 'all') theme = themesPool[Math.floor(Math.random() * themesPool.length)];

            // Use a simpler URL to ensure compatibility
            const url = `https://chess-puzzles-api.vercel.app/puzzles?themes=${theme}&min_rating=${r}&max_rating=${r + 400}&limit=50&_t=${Date.now()}`;

            console.log("üîç Intentando cargar puzzle (" + (retryCount + 1) + "):", url);
            $('#puz-desc').html("<span style='color:var(--accent)'>üì° Conectando con Lichess (Intento " + (retryCount + 1) + ")...</span>");

            try {
                const response = await fetch(url);
                const data = await response.json();

                if (data && data.length > 0) {
                    // Evitar repetidos
                    const fresh = data.filter(p => !solvedPuzzles.includes(p.PuzzleId));
                    const p = fresh.length > 0 ? fresh[Math.floor(Math.random() * fresh.length)] : data[0];

                    currentPuzzle = {
                        id: p.PuzzleId,
                        fen: p.FEN,
                        sol: p.Moves.split(' '),
                        rating: p.Rating,
                        themes: p.Themes
                    };

                    puzzleStep = 0;
                    game.load(currentPuzzle.fen);
                    const firstMove = currentPuzzle.sol[0];
                    game.move({ from: firstMove.substring(0, 2), to: firstMove.substring(2, 4), promotion: firstMove[4] || 'q' });
                    puzzleStep = 1;

                    board.position(game.fen());
                    board.orientation(game.turn() === 'w' ? 'white' : 'black');

                    $('#puz-desc').html(`
                        <div style="color:var(--accent); font-weight:bold; margin-bottom:4px;">Tu turno (${currentPuzzle.rating})</div>
                        <div style="color:#3b82f6; font-size:0.6rem; text-transform:uppercase; font-weight:800;">${currentPuzzle.themes.split(',').slice(0, 2).join(', ')}</div>
                    `);
                    updateUI();
                } else {
                    console.warn("‚ö†Ô∏è API devolvi√≥ vac√≠o para:", theme);
                    loadRandomPuzzle(retryCount + 1);
                }
            } catch (err) {
                console.error("üö® Error cr√≠tico API:", err);
                loadRandomPuzzle(retryCount + 1);
            }
        }

        // Stockfish Loader
        try {
            fetch('https://cdnjs.cloudflare.com/ajax/libs/stockfish.js/10.0.0/stockfish.js').then(r => r.blob()).then(b => {
                stockfish = new Worker(URL.createObjectURL(b));
                stockfish.postMessage('uci');
                stockfish.onmessage = (e) => {
                    var l = e.data;
                    if (l.includes('score cp')) {
                        var cp = parseInt(l.match(/score cp (-?\d+)/)[1]) / 100;
                        var ev = (game.turn() === 'w' ? cp : -cp);
                        var h = Math.max(0, Math.min(100, 50 + (ev * 15)));
                        $('#eval-fill-master').css('height', h + '%');

                        var pv = l.match(/ pv ([a-h0-9]{4})/);
                        if (pv && pv[1]) {
                            if (showHints) {
                                $('#best-move-display').html("üí° Sugerencia: <b style='color:white'>" + pv[1] + "</b>").show();
                                $('.square-55d63').removeClass('highlight-hint');
                                $('[data-square="' + pv[1].substring(0, 2) + '"]').addClass('highlight-hint');
                                $('[data-square="' + pv[1].substring(2, 4) + '"]').addClass('highlight-hint');
                            }
                            if (isJ) {
                                var diff = lastEv - ev;
                                var q = getQualityMsg(diff, l.includes('mate'));
                                var acc = Math.max(0, Math.min(100, 100 - (diff * 25)));

                                $('#coach-txt').html(`
                                    <div class="${q.class}" style="font-size:1.1rem; margin-bottom:5px;">${q.text}</div>
                                    <div style="font-size:0.7rem; color:var(--text-muted);">Precisi√≥n: ${acc.toFixed(1)}%</div>
                                    <div style="font-size:0.8rem; margin-top:5px;">La IA sugiere <b>${pv[1]}</b>.</div>
                                `);
                                isJ = false;
                            }
                        }
                        lastEv = ev;
                    }
                    if (l.startsWith('bestmove') && currentMode === 'ai' && game.turn() !== myColor) {
                        var m = l.split(' ')[1];
                        game.move({ from: m.substring(0, 2), to: m.substring(2, 4), promotion: 'q' });
                        board.position(game.fen());
                        updateUI(true);
                        checkGameOver();
                    }
                };
            });
        } catch (e) { }

        function checkGameOver() {
            if (game.game_over()) {
                let result = 0.5; // Tablas
                if (game.in_checkmate()) {
                    result = (game.turn() !== myColor) ? 1 : 0; // Si el que movi√≥ gan√≥
                    $('#overlay-msg').text(LANGS[currentLang].mate);
                    $('#game-overlay').css('display', 'flex');
                    playSnd('end');
                }
                stopClock();

                // Save to history
                saveToHistory(result);

                if (currentMode === 'ai') {
                    updateElo(getAiElo(), result);
                } else if (currentMode === 'local') {
                    updateElo(800, result);
                }

                const msg = result === 1 ? LANGS[currentLang].win : (result === 0 ? LANGS[currentLang].lose : LANGS[currentLang].draw);
                alert("Fin de la partida: " + msg);
            }
        }

        function saveToHistory(res) {
            const hist = JSON.parse(localStorage.getItem('chess_game_history') || '[]');
            const gameData = {
                date: new Date().toLocaleString(),
                opp: $('#opp-name').text(),
                me: userName,
                res: res,
                moves: historyPositions, // Guardamos los FENs para navegar
                pgn: game.pgn(),
                mode: currentMode
            };
            hist.unshift(gameData);
            localStorage.setItem('chess_game_history', JSON.stringify(hist.slice(0, 20))); // Top 20
        }

        function resignGame() {
            if (confirm(LANGS[currentLang].resign)) {
                stopClock();
                if (currentMode === 'ai') updateElo(getAiElo(), 0);
                if (currentMode === 'local' && gameId) {
                    socket.emit('resign_game', { gameId: gameId, user: userName });
                    updateElo(800, 0);
                }
                game.reset(); board.start(); updateUI();
                alert(LANGS[currentLang].lose);
            }
        }

        function abortGame() {
            if (confirm(LANGS[currentLang].abort)) {
                stopClock();
                if (currentMode === 'local' && gameId) {
                    socket.emit('abort_online_game', { gameId: gameId });
                }
                game.reset(); board.start(); updateUI();
            }
        }

        function updateHistory() {
            historyPositions.push(game.fen());
            currentHistoryIndex = historyPositions.length - 1;
        }

        function navigateHistory(dir) {
            if (dir === 'first') currentHistoryIndex = 0;
            else if (dir === 'last') currentHistoryIndex = historyPositions.length - 1;
            else if (dir === 'prev') currentHistoryIndex = Math.max(0, currentHistoryIndex - 1);
            else if (dir === 'next') currentHistoryIndex = Math.min(historyPositions.length - 1, currentHistoryIndex + 1);

            board.position(historyPositions[currentHistoryIndex]);
        }

        function updateUI(moved = false) {
            $('.square-55d63').removeClass('highlight-selected highlight-hint');
            $('.legal-dot').remove();
            if (moved) {
                // Sound logic
                if (game.in_check()) playSnd('check');
                else if (game.history({ verbose: true }).pop().flags.includes('c')) playSnd('capture');
                else playSnd('move');

                updateHistory();
                if (!gameStarted && currentMode !== 'exercises' && currentMode !== 'study') startClock();
                if (currentMode !== 'exercises' && currentMode !== 'study') updateTimerVisuals();
                isJ = true;
                if (stockfish) {
                    stockfish.postMessage('stop');
                    stockfish.postMessage('position fen ' + game.fen());
                    stockfish.postMessage('go depth 12');
                }
            }
        }

        function onSquareClick(sq) {
            if (selectedSq) {
                if (selectedSq === sq) { selectedSq = null; updateUI(); return; }

                if (currentMode === 'exercises') {
                    const tempGame = new Chess(game.fen());
                    const move = tempGame.move({ from: selectedSq, to: sq, promotion: 'q' });

                    if (move) {
                        const expectedMove = currentPuzzle.sol[puzzleStep];
                        const playerMove = move.from + move.to + (move.promotion || "");

                        if (playerMove === expectedMove) {
                            game.move(move);
                            board.position(game.fen());
                            puzzleStep++;

                            if (puzzleStep >= currentPuzzle.sol.length) {
                                clearInterval(puzTimerInterval);
                                $('#coach-txt').html(`<b style='color:var(--success)'>¬°EXCELENTE! Puzzle resuelto en ${formatTime(puzSeconds)}.</b>`);
                                playSnd('end');
                                if (currentPuzzle.id && !solvedPuzzles.includes(currentPuzzle.id)) {
                                    solvedPuzzles.push(currentPuzzle.id);
                                    localStorage.setItem('chess_solved_puzzles', JSON.stringify(solvedPuzzles.slice(-1000)));
                                }
                                updateElo(userPuzzleElo + 200, 1, true);
                                setTimeout(loadRandomPuzzle, 1500);
                            } else {
                                // Mover la pieza de la IA en el puzzle
                                setTimeout(() => {
                                    const nextMove = currentPuzzle.sol[puzzleStep];
                                    const m = game.move({
                                        from: nextMove.substring(0, 2),
                                        to: nextMove.substring(2, 4),
                                        promotion: nextMove.length > 4 ? nextMove[4] : 'q'
                                    });
                                    board.position(game.fen());
                                    puzzleStep++;
                                    // IA sound
                                    if (m.flags.includes('c')) playSnd('capture'); else playSnd('move');
                                }, 500);
                            }
                        } else {
                            $('#coach-txt').html("<b style='color:var(--trap-color)'>¬°MOVIMIENTO INCORRECTO!</b>");
                            playSnd('error');
                            updateElo(userPuzzleElo + 200, 0, true);
                            setTimeout(() => {
                                game.load(currentPuzzle.fen);
                                // Re-aplicar el primer movimiento del oponente
                                const firstMove = currentPuzzle.sol[0];
                                game.move({
                                    from: firstMove.substring(0, 2),
                                    to: firstMove.substring(2, 4),
                                    promotion: firstMove.length > 4 ? firstMove[4] : 'q'
                                });
                                board.position(game.fen());
                                puzzleStep = 1;
                                updateUI();
                            }, 1000);
                        }
                    }
                    selectedSq = null;
                    updateUI();
                    return;
                }

                var move = game.move({ from: selectedSq, to: sq, promotion: 'q' });
                if (move) {
                    board.position(game.fen());
                    selectedSq = null;

                    if (currentMode === 'local') {
                        socket.emit('move', { move: move, gameId: gameId });
                    }

                    updateUI(true);
                    checkGameOver();
                    return;
                }
            }
            var piece = game.get(sq);
            if (piece && piece.color === game.turn()) {
                selectedSq = sq;
                updateUI();
                $('[data-square="' + sq + '"]').addClass('highlight-selected');
                game.moves({ square: sq, verbose: true }).forEach(m => {
                    $('[data-square="' + m.to + '"]').append('<div class="legal-dot"></div>');
                });
            }
        }

        $(document).ready(() => {
            game = new Chess(); // Ensure instance
            board = Chessboard('myBoard', {
                draggable: true, position: 'start',
                pieceTheme: 'https://chessboardjs.com/img/chesspieces/wikipedia/{piece}.png',
                onDrop: (s, t) => {
                    var m = game.move({ from: s, to: t, promotion: 'q' });
                    if (!m) { playSnd('error'); return 'snapback'; }

                    if (currentMode === 'local') {
                        socket.emit('move', { move: m, gameId: gameId });
                    }

                    updateUI(true);
                    checkGameOver();
                }
            });
            // TABS LOGIC
            $('.tab-btn').click(function () {
                $('.tab-btn').removeClass('active');
                $(this).addClass('active');
                const tab = $(this).data('tab');
                $('.tab-content').removeClass('active');
                $('#' + tab).addClass('active');

                if (tab === 'tab-ranking') {
                    socket.emit('get_leaderboard');
                }
                if (tab === 'tab-history') {
                    renderHistory();
                }
            });

            function renderHistory() {
                const list = $('#history-list');
                const hist = JSON.parse(localStorage.getItem('chess_game_history') || '[]');
                list.empty();
                if (hist.length === 0) list.append('<div style="text-align:center; padding:20px; color:var(--text-muted); font-size:0.7rem;">No hay partidas grabadas.</div>');

                hist.forEach((g, i) => {
                    let resClass = "res-draw";
                    let resTxt = "1/2-1/2";
                    if (g.res === 1) { resClass = "res-win"; resTxt = "GANADA"; }
                    if (g.res === 0) { resClass = "res-lose"; resTxt = "PERDIDA"; }

                    const item = $(`
                        <div class="history-item" onclick="viewHistoryGame(${i})">
                            <div class="hist-date">${g.date} ‚Ä¢ ${g.mode.toUpperCase()}</div>
                            <div class="hist-main">
                                <div class="hist-players">${g.me} vs ${g.opp}</div>
                                <div class="hist-result ${resClass}">${resTxt}</div>
                            </div>
                        </div>
                    `);
                    list.append(item);
                });
            }

            window.viewHistoryGame = (index) => {
                const hist = JSON.parse(localStorage.getItem('chess_game_history') || '[]');
                const g = hist[index];
                if (!g) return;

                // Change to study mode
                $('.mode-pill').removeClass('active');
                $('[data-mode="study"]').addClass('active');
                currentMode = 'study';
                $('.mode-section').removeClass('active');
                $('#sec-study').addClass('active');

                // Load game
                historyPositions = g.moves;
                currentHistoryIndex = 0;
                game.load(historyPositions[0]);
                board.position(game.fen());

                // Show tab play
                $('.tab-btn').removeClass('active');
                $('.tab-btn[data-tab="tab-play"]').addClass('active');
                $('.tab-content').removeClass('active');
                $('#tab-play').addClass('active');

                alert("Partida cargada. Usa las flechas para navegar y el bot√≥n ANALIZAR para recibir consejos.");
                updateUI();
            };

            socket.on('leaderboard_data', (data) => {
                const list = $('#global-ranking');
                list.empty();
                data.forEach((p, i) => {
                    let rankClass = "";
                    if (i === 0) rankClass = "rank-top1";
                    else if (i === 1) rankClass = "rank-top2";
                    else if (i === 2) rankClass = "rank-top3";

                    const item = `
                        <div class="ranking-item">
                            <div style="display:flex; align-items:center; gap:10px;">
                                <div class="rank-num ${rankClass}">${i + 1}</div>
                                <span style="font-weight:700;">${p.user}</span>
                            </div>
                            <b style="color:var(--accent);">${p.elo} ELO</b>
                        </div>
                    `;
                    list.append(item);
                });
            });

            $(window).resize(board.resize);

            $(document).on('mousedown touchstart', '.square-55d63', function () {
                onSquareClick($(this).data('square'));
            });

            $('.mode-pill').click(function () {
                $('.mode-pill').removeClass('active'); $(this).addClass('active');
                currentMode = $(this).data('mode');
                $('.mode-section').removeClass('active');
                $('#sec-' + currentMode).addClass('active');
                stopClock();
                gameStarted = false;

                if (currentMode === 'exercises') {
                    loadRandomPuzzle();
                } else {
                    game.reset(); board.start(); updateUI();
                    historyPositions = ['start']; currentHistoryIndex = 0;
                    resetTimers();
                }
            });

            // Nav Handlers
            $('#btn-nav-first').click(() => navigateHistory('first'));
            $('#btn-nav-prev').click(() => navigateHistory('prev'));
            $('#btn-nav-next').click(() => navigateHistory('next'));
            $('#btn-nav-last').click(() => navigateHistory('last'));

            // Online / Local Logic
            $('#btn-create').click(function () {
                if (!isAuth) { alert("Solo usuarios registrados pueden crear retos."); return openAuth(); }
                gameId = Math.random().toString(36).substr(2, 9);
                myColor = 'w';
                board.orientation('white');
                const info = {
                    id: gameId,
                    user: userName,
                    elo: userElo,
                    time: $('#local-time-selector .time-btn.active').data('time')
                };
                socket.emit('create_challenge', info);
                alert("Reto creado. Esperando oponente...");
            });

            socket.on('lobby_update', (challenges) => {
                $('#challenges-list').empty();
                if (challenges.length === 0) {
                    $('#challenges-list').html('<div style="font-size:0.65rem; color:var(--text-muted); text-align:center; padding:10px;">Buscando retos...</div>');
                } else {
                    challenges.forEach(data => {
                        const html = `
                            <div class="challenge-item" onclick="joinGame('${data.id}', '${data.user}', '${data.time}')" 
                                 style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:6px; cursor:pointer; font-size:0.7rem;">
                                <span>üë§ ${data.user} (${data.elo})</span>
                                <span style="color:var(--accent)">${data.time} min ‚öîÔ∏è</span>
                            </div>
                        `;
                        $('#challenges-list').append(html);
                    });
                }
            });

            socket.on('new_challenge', (data) => {
                if ($('#challenges-list .no-challenges').length) $('#challenges-list').empty();
                const html = `
                    <div class="challenge-item" onclick="joinGame('${data.id}', '${data.user}', '${data.time}')" 
                         style="display:flex; justify-content:space-between; align-items:center; padding:8px; background:rgba(255,255,255,0.05); margin-bottom:5px; border-radius:6px; cursor:pointer; font-size:0.7rem;">
                        <span>üë§ ${data.user} (${data.elo})</span>
                        <span style="color:var(--accent)">${data.time} min ‚öîÔ∏è</span>
                    </div>
                `;
                $('#challenges-list').append(html);
                playSnd('move');
            });

            window.joinGame = (id, oppName, time) => {
                if (!isAuth) { alert("Solo usuarios registrados pueden unirse a retos."); return openAuth(); }
                gameId = id;
                myColor = 'b';
                board.orientation('black');
                $('#opp-name').text(oppName);
                socket.emit('join_challenge', { id: id, user: userName });
                game.reset();
                board.start();
                resetTimers();
                const mins = parseInt(time) || 10;
                whiteTime = mins * 60;
                blackTime = mins * 60;
                updateUI();
                alert("Te has unido a la partida de " + oppName);
            };

            socket.on('opponent_joined', (data) => {
                $('#opp-name').text(data.user);
                resetTimers();
                const mins = parseInt($('#local-time-selector .time-btn.active').data('time')) || 10;
                whiteTime = mins * 60;
                blackTime = mins * 60;
                updateUI();
                alert(data.user + " se ha unido a tu reto. ¬°Empiezan las Blancas!");
            });

            socket.on('player_resigned', (data) => {
                stopClock();
                const winner = data.user === userName ? 'Oponente' : 'T√∫';
                alert("Tu oponente se ha rendido. ¬°Has ganado!");
                updateElo(800, 1);
                game.reset(); board.start(); updateUI();
            });

            socket.on('game_aborted', () => {
                alert("La partida ha sido abortada.");
                stopClock();
                game.reset(); board.start(); updateUI();
            });

            // CHAT LOGIC
            const sendChat = (customMsg = null) => {
                const msg = customMsg || $('#chat-input').val().trim();
                if (!msg) return;
                socket.emit('chat_message', { user: userName, msg: msg, gameId: gameId });
                appendMsg(userName, msg, true);
                $('#chat-input').val('');
            };

            $('.btn-emoji').click(function () {
                sendChat($(this).data('emoji'));
            });

            const appendMsg = (user, msg, isMine) => {
                const html = `<div class="chat-msg ${isMine ? 'mine' : 'other'}">
                                <b style="font-size:0.6rem; display:block; opacity:0.8;">${user}</b>
                                ${msg}
                             </div>`;
                $('#chat-msgs').append(html);
                $('#chat-msgs').scrollTop($('#chat-msgs')[0].scrollHeight);
            };

            $('#btn-chat-send').click(sendChat);
            $('#chat-input').keypress((e) => { if (e.which === 13) sendChat(); });

            socket.on('chat_message', (data) => {
                if (!gameId || data.gameId === gameId) {
                    appendMsg(data.user, data.msg, false);
                    playSnd('move'); // Alert sound
                }
            });

            socket.on('move', (data) => {
                if (data.gameId === gameId || !gameId) {
                    game.move(data.move);
                    board.position(game.fen());
                    updateUI(true);
                    checkGameOver();
                }
            });

            // Resign/Abort Handlers
            $('#btn-resign-ai, #btn-resign-local').click(resignGame);
            $('#btn-abort').click(abortGame);

            // Theme Handlers
            $('#board-theme-sel').change(function () {
                const theme = $(this).val();
                let colors = { light: '#f0d9b5', dark: '#b58863' }; // default classic
                if (theme === 'wood') colors = { light: '#eec', dark: '#8b4513' };
                if (theme === 'neon') colors = { light: '#1e293b', dark: '#0f172a' };
                if (theme === 'forest') colors = { light: '#acc', dark: '#2e8b57' };

                $('.white-1e1d7').css('background', colors.light);
                $('.black-3c85d').css('background', colors.dark);
            });

            $('#piece-theme-sel').change(function () {
                const theme = $(this).val();
                let pieceUrl = (p) => 'https://chessboardjs.com/img/chesspieces/wikipedia/' + p + '.png';
                if (theme === 'alpha') pieceUrl = (p) => 'https://lichess1.org/assets/piece/alpha/' + p + '.svg';
                if (theme === 'uscf') pieceUrl = (p) => 'https://lichess1.org/assets/piece/uscf/' + p + '.svg';

                const currentPos = board.position();
                const orientation = board.orientation();

                board = Chessboard('myBoard', {
                    draggable: true,
                    position: currentPos,
                    orientation: orientation,
                    pieceTheme: pieceUrl,
                    onDrop: (s, t) => {
                        var m = game.move({ from: s, to: t, promotion: 'q' });
                        if (!m) { playSnd('error'); return 'snapback'; }
                        updateUI(true);
                        checkGameOver();
                    }
                });
                playSnd('move');
            });

            $('#btn-toggle-sound').off('click').click(function () {
                soundOn = !soundOn;
                localStorage.setItem('chess_sound', soundOn);
                $(this).text(`üîä Sonidos: ${soundOn ? 'ON' : 'OFF'}`);
                if (soundOn) playSnd('move');
            });

            $('#lang-sel').on('change', function () { setLanguage($(this).val()); });

            function resetTimers() {
                const activeSelector = currentMode === 'ai' ? '#ai-time-selector' : '#local-time-selector';
                const mins = parseInt($(activeSelector + ' .time-btn.active').data('time')) || 10;
                whiteTime = mins * 60;
                blackTime = mins * 60;
                $('#my-timer, #opp-timer').text(formatTime(whiteTime)).removeClass('low-time active');
            }

            $('.time-btn').click(function () {
                $(this).siblings().removeClass('active');
                $(this).addClass('active');
                resetTimers();
            });

            $('#btn-analyze-game').click(() => {
                if (historyPositions.length < 2) return alert("Juega un poco antes de analizar.");
                alert("Modo An√°lisis Activo. Mueve por el historial para ver la calidad de tus jugadas.");
                analysisActive = true;
                isJ = true;
                stockfish.postMessage('stop');
                stockfish.postMessage('position fen ' + game.fen());
                stockfish.postMessage('go depth 14');
            });

            $('#btn-show-sol').click(() => {
                if (!currentPuzzle) return;
                const move = currentPuzzle.sol[puzzleStep];
                const from = move.substring(0, 2);
                const to = move.substring(2, 4);
                $('.square-55d63').removeClass('highlight-hint');
                $('[data-square="' + from + '"]').addClass('highlight-hint');
                $('[data-square="' + to + '"]').addClass('highlight-hint');
                playSnd('error');
            });

            $('#btn-puz-hint').click(() => {
                if (!currentPuzzle) return;
                const move = currentPuzzle.sol[puzzleStep];
                const from = move.substring(0, 2);
                const to = move.substring(2, 4);

                // Highlight the squares
                $('.square-55d63').removeClass('highlight-hint');
                $('[data-square="' + from + '"]').addClass('highlight-hint');
                $('[data-square="' + to + '"]').addClass('highlight-hint');

                $('#coach-txt').html(`F√≠jate en la casilla <b style="color:var(--accent)">${from}</b>. ¬øQu√© pieza podr√≠as mover ah√≠ o desde ah√≠?`);
                updateElo(userPuzzleElo, 0.2, true); // Penalty for hint
            });

            $('#btn-next-puz').click(() => loadRandomPuzzle());
            $('#puz-cat-sel').change(() => loadRandomPuzzle());
            $('#header-elo-puz, #puz-elo-display').text(userPuzzleElo + "üß©");

            // AUTH LOGIC
            const openAuth = () => { $('#auth-modal').css('display', 'flex'); $('#side-drawer').removeClass('open'); $('#side-drawer-overlay').fadeOut(); };
            $('#btn-auth-trigger, #btn-auth-drawer').click(openAuth);
            $('#btn-auth-close').click(() => $('#auth-modal').hide());
            $('#auth-switch').click(function () {
                const isLogin = $('#auth-title').text() === "INICIAR SESI√ìN";
                $('#auth-title').text(isLogin ? "REGISTRARSE" : "INICIAR SESI√ìN");
                $('#btn-auth-submit').text(isLogin ? "REGISTRAR" : "ENTRAR");
                $('#reg-group').toggle();
                $(this).html(isLogin ? "¬øYa tienes cuenta? <span style='color:var(--accent)'>Entra</span>" : "¬øNo tienes cuenta? <span style='color:var(--accent)'>Reg√≠strate</span>");
            });

            const updateAuthUI = () => {
                if (localStorage.getItem('chess_is_auth') === 'true') {
                    isAuth = true;
                    userName = localStorage.getItem('chess_username');
                    userElo = parseInt(localStorage.getItem('chess_user_elo')) || 500;
                    userPuzzleElo = parseInt(localStorage.getItem('chess_puz_elo')) || 500;

                    $('#btn-auth-trigger').text("üë§ " + userName);
                    $('#my-name-display').text(userName);
                    $('#btn-auth-drawer').text("CERRAR SESI√ìN").off('click').click(() => {
                        localStorage.clear(); location.reload();
                    });
                    $('#drawer-user-name').text(userName);
                    $('#drawer-user-elo, #header-elo').text(userElo + " ELO");
                    $('#header-elo-puz, #puz-elo-display').text(userPuzzleElo + "üß©");
                }
            };

            $('.mode-pill').on('click', function () {
                const mode = $(this).data('mode');
                if (mode === 'ai') $('#opp-name').text('Stockfish');
                else if (mode === 'local') $('#opp-name').text('Oponente Online');
                else $('#opp-name').text('Oponente');
            });

            $('#btn-auth-submit').click(() => {
                const name = $('#auth-user').val();
                const pass = $('#auth-pass').val();
                const email = $('#auth-email').val();
                const isReg = $('#reg-group').is(':visible');

                if (!name || !pass) return alert("Completa los campos.");
                if (isReg && !email) return alert("Escribe un email.");

                if (isReg) {
                    socket.emit('register', { user: name, pass: pass, email: email });
                } else {
                    socket.emit('login', { user: name, pass: pass });
                }
            });

            socket.on('auth_success', (data) => {
                userName = data.user;
                userElo = data.elo;
                userPuzzleElo = data.puzElo;
                isAuth = true;

                localStorage.setItem('chess_username', userName);
                localStorage.setItem('chess_is_auth', 'true');
                localStorage.setItem('chess_user_elo', userElo);
                localStorage.setItem('chess_puz_elo', userPuzzleElo);

                updateAuthUI();
                $('#auth-modal').hide();
                alert("¬°Bienvenido, " + userName + "!");
            });

            socket.on('auth_error', (msg) => {
                alert("Error: " + msg);
            });

            updateAuthUI();

            $('#hamburger-menu').click(() => { $('#side-drawer').addClass('open'); $('#side-drawer-overlay').fadeIn(); });
            $('#side-drawer-overlay').click(() => { $('#side-drawer').removeClass('open'); $('#side-drawer-overlay').fadeOut(); });

            // Llenar aperturas
            OPENINGS_DATA[0].items.forEach((o, i) => $('#opening-sel').append(`<option value="${i}">${o.name}</option>`));
            $('#opening-sel').change(function () {
                var o = OPENINGS_DATA[0].items[$(this).val()];
                if (!o) return;
                game.reset(); o.m.forEach(m => game.move(m));
                board.position(game.fen()); updateUI(true);
            });

            $('.mode-pill').click(function () {
                $('.mode-pill').removeClass('active');
                $(this).addClass('active');
                currentMode = $(this).data('mode');

                $('.mode-section').removeClass('active');
                $('#sec-' + currentMode).addClass('active');

                // Switch to "JUEGO" tab automatically
                $('.tab-btn').removeClass('active');
                $('.tab-btn[data-tab="tab-play"]').addClass('active');
                $('.tab-content').removeClass('active');
                $('#tab-play').addClass('active');

                if (currentMode === 'ai') $('#opp-name').text('Stockfish');
                else if (currentMode === 'local') $('#opp-name').text('Oponente Online');
                else if (currentMode === 'exercises') loadRandomPuzzle();
                else $('#opp-name').text('Oponente');

                resetTimers();
                updateUI();
            });

            $('#btn-pgn').click(function () {
                const pgn = prompt("Pega el PGN de la partida:");
                if (pgn) {
                    if (game.load_pgn(pgn)) {
                        board.position(game.fen());
                        historyPositions = ['start', ...game.history().map((m, i) => {
                            const g2 = new Chess();
                            game.history().slice(0, i + 1).forEach(mv => g2.move(mv));
                            return g2.fen();
                        })];
                        currentHistoryIndex = historyPositions.length - 1;
                        updateUI(true);
                        alert("Partida cargada correctamente.");
                    } else {
                        alert("Error: PGN no v√°lido.");
                    }
                }
            });

            // Initial mode setup
            $('.mode-section').removeClass('active');
            $('#sec-' + currentMode).addClass('active');
            $(`.mode-pill[data-mode="${currentMode}"]`).addClass('active');
        });
    </script>
</body>

</html>