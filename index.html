<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Chess Drez | Maestro IA & Puzzles</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>‚ôüÔ∏è</text></svg>">

    <!-- LIBRER√çAS -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/chessboard-js/1.0.0/chessboard-1.0.0.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/chess.js/0.10.3/chess.min.js"></script>
    <script src="https://cdn.socket.io/4.7.2/socket.io.min.js"></script>
    <link rel="manifest" href="manifest.json">
    <script src="puzzles_data.js"></script>
    <script src="openings_enhanced.js"></script>
    <script src="knowledge_base.js"></script>
    <meta name="theme-color" content="#32a09b">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="board_stability.css">
    <link rel="stylesheet" href="academy.css">
</head>

<body>
    <div id="toast-container"></div>
    <div id="mobile-panel-overlay"></div>

    <header class="app-header">
        <div class="header-left">
            <div id="hamburger-menu">‚ò∞</div>
            <div class="logo-area" onclick="goBackToMenu()">
                <img src="logo.jpg" alt="Logo" class="logo-img">
                <span class="logo-text">Chess <span class="accent-text">Drez</span></span>
            </div>
        </div>

        <!-- Navegaci√≥n estilo pesta√±as (Centro) -->
        <nav class="header-center desktop-only" id="main-nav">
            <div class="nav-center-link active" data-section="jugar" onclick="showSubMenu('jugar')">JUGAR</div>
            <div class="nav-center-link" data-section="puzzles" onclick="showSubMenu('puzzles')">T√ÅCTICAS</div>
            <div class="nav-center-link" data-section="academia" onclick="showSubMenu('academy')">ACADEMIA</div>
            <div class="nav-center-link" data-section="aperturas" onclick="showSubMenu('aperturas')">APERTURAS</div>
            <div class="nav-center-link" data-section="analisis" onclick="showSubMenu('analisis')">AN√ÅLISIS</div>
        </nav>

        <!-- Stats y Auth (Derecha) -->
        <div class="header-right">
            <div class="user-stats">
                <!-- Rango oculto si es confuso, solo Elo -->
                <div class="stat-item" style="display:none;">
                    <span class="stat-label">Rango</span>
                    <span class="stat-val" style="color:var(--warning)">Grandmaster</span>
                </div>
                <div class="stat-item">
                    <span class="stat-label">ELO</span>
                    <span class="stat-val" id="header-elo" style="font-size:1.1rem; color:var(--accent);">500</span>
                </div>
            </div>
            <div id="btn-auth-trigger" class="auth-btn">üë§ Acceder</div>
        </div>
    </header>

    <div class="main-layout">
        <!-- SIDEBAR IZQUIERDA -->
        <nav class="sidebar">

            <div class="nav-links">
                <div class="nav-item" onclick="goBackToMenu()" id="nav-home">
                    <span class="nav-icon">üè†</span>
                    <span class="nav-text">Inicio</span>
                </div>
                <div class="nav-item" onclick="showSubMenu('jugar')" id="nav-jugar">
                    <span class="nav-icon">‚öîÔ∏è</span>
                    <span class="nav-text">Jugar</span>
                </div>
                <div class="nav-item" onclick="showSubMenu('academy')" id="nav-academy">
                    <span class="nav-icon">üéì</span>
                    <span class="nav-text">Academia</span>
                </div>
                <div class="nav-item" onclick="showSubMenu('aperturas')" id="nav-aperturas">
                    <span class="nav-icon">üéì</span>
                    <span class="nav-text">Aperturas</span>
                </div>
                <div class="nav-item" onclick="showSubMenu('puzzles')" id="nav-tacticas">
                    <span class="nav-icon">üß©</span>
                    <span class="nav-text">T√°cticas</span>
                </div>
                <div class="nav-item" onclick="showSubMenu('historial')" id="nav-historial">
                    <span class="nav-icon">üìà</span>
                    <span class="nav-text">Historial</span>
                </div>
            </div>

            <!-- APERTURAS SELECTOR CONTAINER -->
            <div id="opening-sel-container" style="display:none; padding:10px 20px; background: rgba(0,0,0,0.2);">
                <label
                    style="font-size:0.6rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:5px;">SELECCIONAR
                    APERTURA</label>
                <select id="opening-sel-main" class="custom-select">
                    <option value="">-- Elige una --</option>
                </select>
                <select id="opening-sel" style="display:none;"></select> <!-- Legacy hidden sync -->
            </div>

            <div class="sidebar-bottom">
                <div class="appearance-settings">
                    <label>TABLERO</label>
                    <select id="board-theme-sel" class="custom-select" style="margin-bottom:12px;">
                        <option value="classic">Cl√°sico (Azul)</option>
                        <option value="wood">Madera</option>
                        <option value="neon">Neon Dark</option>
                        <option value="forest">Bosque</option>
                    </select>

                    <label>PIEZAS</label>
                    <select id="piece-theme-sel" class="custom-select" style="margin-bottom:12px;">
                        <option value="wikipedia">Wikipedia</option>
                        <option value="alpha">Alpha</option>
                        <option value="uscf">USCF</option>
                    </select>


                    <!-- AI GENERATIVA CONFIGURATION (DESACTIVADO TEMPORALMENTE) -->
                    <div
                        style="display:none; margin-top: 20px; padding-top: 15px; border-top: 1px solid rgba(255,255,255,0.1);">
                        <label
                            style="display:flex; justify-content:space-between; align-items:center; margin-bottom:10px;">
                            <span>ü§ñ IA GENERATIVA</span>
                            <label class="toggle-switch-small">
                                <input type="checkbox" id="ai-enabled-toggle"
                                    onchange="toggleAIExplanations(this.checked)">
                                <span class="slider-small"></span>
                            </label>
                        </label>

                        <div id="ai-config-panel" style="display:none; margin-top:10px;">
                            <label
                                style="font-size:0.65rem; opacity:0.7; margin-bottom:5px; display:block;">PROVEEDOR</label>
                            <select id="ai-provider-sel" class="custom-select"
                                style="margin-bottom:10px; font-size:0.8rem;">
                                <option value="openai">OpenAI (GPT-4)</option>
                                <option value="claude">Claude (Anthropic)</option>
                                <option value="perplexity">Perplexity</option>
                            </select>

                            <label style="font-size:0.65rem; opacity:0.7; margin-bottom:5px; display:block;">API
                                KEY</label>
                            <div class="input-container" style="position:relative;">
                                <input type="password" id="ai-api-key-input" placeholder="sk-..."
                                    style="width:100%; padding:8px; background:rgba(0,0,0,0.3); border:1px solid var(--border); border-radius:6px; color:#fff; font-size:0.75rem;"
                                    onchange="saveAIConfig()">
                                <span class="password-toggle" onclick="togglePasswordVisibility('ai-api-key-input')"
                                    style="position:absolute; right:8px; top:50%; transform:translateY(-50%); cursor:pointer; font-size:1rem;">üëÅÔ∏è</span>
                            </div>

                            <p style="font-size:0.6rem; opacity:0.6; margin-top:8px; line-height:1.3;">
                                üí° Tu clave se guarda localmente y nunca se comparte.
                                <a href="#" onclick="showAIHelp(); return false;" style="color:var(--accent);">¬øC√≥mo
                                    obtener una?</a>
                            </p>
                        </div>
                    </div>
                </div>
            </div>
        </nav>

        <!-- ZONA DE JUEGO (CENTRO) -->
        <main class="game-zone">
            <!-- Men√∫s Emergentes / Submen√∫s -->
            <div id="submenus-container">
                <div class="menu-step active" id="menu-home">
                    <div class="hero-section">
                        <div class="hero-content">
                            <!-- LOGO PREMIUM M√ìVIL (S√ìLO MOBILE) -->
                            <div class="mobile-hero-logo">
                                <div class="logo-circle">
                                    <span class="logo-icon-main">‚ôüÔ∏è</span>
                                </div>
                                <div class="logo-glow"></div>
                            </div>

                            <h1 class="hero-title">Domina el Tablero con <span class="accent-text">Maestro IA</span>
                            </h1>
                            <p class="hero-subtitle">La plataforma de ajedrez definitiva para aprender, entrenar y
                                competir con tecnolog√≠a de vanguardia.</p>

                            <ul class="hero-features-list">
                                <li>‚ú® Motor Stockfish 16 Core</li>
                                <li>üìä An√°lisis Multi-l√≠nea en tiempo real</li>
                                <li>üß© +2,800 Puzzles T√°cticos</li>
                                <li>‚öîÔ∏è Partidas Online y Locales</li>
                            </ul>

                            <div class="hero-actions mobile-hidden">
                                <button class="btn-hero-primary" onclick="showSubMenu('jugar')">Empezar a Jugar</button>
                                <button class="btn-hero-secondary" onclick="window.location.href='kids/kids.html'"
                                    style="background:var(--kids-yellow, #FFD700); color:#000; border:none; font-weight:800; box-shadow:0 6px 0 #b29600;">üåü
                                    Zona Ni√±os</button>
                            </div>

                            <!-- NUEVA PORTADA M√ìVIL PREMIUM -->
                            <div class="mobile-start-menu">
                                <div class="mobile-main-action" onclick="showSubMenu('jugar')">
                                    <div class="action-card-bg"></div>
                                    <div class="action-content">
                                        <div class="action-icon">‚öîÔ∏è</div>
                                        <div class="action-text">
                                            <h3>JUGAR AHORA</h3>
                                            <p>Maestro IA o Partida Online</p>
                                        </div>
                                        <div class="action-arrow">‚Üí</div>
                                    </div>
                                </div>

                                <div class="mobile-menu-grid">
                                    <div class="menu-small-card" onclick="showSubMenu('aperturas')">
                                        <span class="icon">üéì</span>
                                        <span>Aperturas</span>
                                    </div>
                                    <div class="menu-small-card" onclick="showSubMenu('puzzles')">
                                        <span class="icon">üß©</span>
                                        <span>T√°cticas</span>
                                    </div>
                                    <div class="menu-small-card" onclick="showSubMenu('maestro-config')">
                                        <span class="icon">üìä</span>
                                        <span>An√°lisis</span>
                                    </div>
                                    <div class="menu-small-card kids" onclick="window.location.href='kids/kids.html'">
                                        <span class="icon">üåü</span>
                                        <span>Ni√±os</span>
                                    </div>
                                </div>
                            </div>

                            <div class="quick-stats-row mobile-hidden">
                                <div class="q-stat-card">
                                    <span class="q-val">2.8k+</span>
                                    <span class="q-lab">Puzzles</span>
                                </div>
                                <div class="q-stat-card">
                                    <span class="q-val">100%</span>
                                    <span class="q-lab">Gratis</span>
                                </div>
                                <div class="q-stat-card">
                                    <span class="q-val">Stockfish 16</span>
                                    <span class="q-lab">Motor IA</span>
                                </div>
                            </div>
                        </div>
                        <div class="hero-visual mobile-hidden">
                            <div class="hero-board-preview forming">
                                <img src="chess_hero_preview.png" alt="Preview" class="hero-img-preview">
                                <div class="hero-scanner-line"></div>
                                <div class="hero-glass-badge">Powered by AI</div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-root">
                    <!-- Base root menu is now integrated into sidebar, but we keep the logic -->
                </div>

                <div class="menu-step" id="menu-jugar">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Seleccionar Modo</h3>
                    </div>
                    <div class="grid-menu">
                        <div class="card-option" onclick="showSubMenu('maestro-config')">
                            <span class="opt-icon">üéì</span>
                            <h4>Maestro IA</h4>
                        </div>
                        <div class="card-option" onclick="setMode('local')">
                            <span class="opt-icon">‚öîÔ∏è</span>
                            <h4>Partida Online</h4>
                        </div>
                        <div class="card-option" onclick="setMode('pass-and-play')">
                            <span class="opt-icon">üë•</span>
                            <h4>Juego Local</h4>
                        </div>
                    </div>
                </div>

                <!-- CONFIGURACI√ìN MAESTRO IA -->
                <div class="menu-step" id="menu-maestro-config">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="showSubMenu('jugar')">‚Üê</button>
                        <h3 class="menu-title">Configurar Partida IA</h3>
                    </div>

                    <div class="config-container">
                        <!-- DIFICULTAD -->
                        <div class="config-group">
                            <div class="config-label-row">
                                <label>NIVEL DE IA</label>
                                <span id="diff-display"
                                    style="color:var(--accent); font-weight:700;">Principiante</span>
                            </div>
                            <div class="difficulty-bar" id="diff-selector">
                                <!-- Generated by JS or static -->
                                <div class="diff-seg" data-lvl="0" onclick="selectDifficulty(0)"></div>
                                <div class="diff-seg" data-lvl="1" onclick="selectDifficulty(1)"></div>
                                <div class="diff-seg" data-lvl="2" onclick="selectDifficulty(2)"></div>
                                <div class="diff-seg" data-lvl="3" onclick="selectDifficulty(3)"></div>
                                <div class="diff-seg" data-lvl="4" onclick="selectDifficulty(4)"></div>
                                <div class="diff-seg" data-lvl="5" onclick="selectDifficulty(5)"></div>
                                <div class="diff-seg" data-lvl="10" onclick="selectDifficulty(10)"></div>
                                <div class="diff-seg" data-lvl="15" onclick="selectDifficulty(15)"></div>
                                <div class="diff-seg" data-lvl="20" onclick="selectDifficulty(20)"></div>
                            </div>
                            <p class="config-desc" id="diff-desc">ELO Aprox: 300</p>
                        </div>

                        <!-- TIEMPO -->
                        <div class="config-group">
                            <label>CONTROL DE TIEMPO</label>
                            <div class="option-row">
                                <button class="btn-option" onclick="selectTime('3+2')">‚ö° 3+2</button>
                                <button class="btn-option active" onclick="selectTime('10+0')">‚è±Ô∏è 10 min</button>
                                <button class="btn-option" onclick="selectTime('30+0')">üê¢ 30 min</button>
                                <button class="btn-option" onclick="selectTime('unlimited')">‚ôæÔ∏è Sin L√≠mite</button>
                            </div>
                        </div>

                        <!-- COLOR -->
                        <div class="config-group">
                            <label>JUGAR COMO</label>
                            <div class="option-row color-selector">
                                <button class="btn-option active" onclick="selectSide('white')">‚ö™ Blancas</button>
                                <button class="btn-option" onclick="selectSide('random')">üé≤ Azar</button>
                                <button class="btn-option" onclick="selectSide('black')">‚ö´ Negras</button>
                            </div>
                        </div>

                        <button class="btn-action-primary start-game-btn" onclick="launchMaestroGame()">
                            COMENZAR PARTIDA
                        </button>
                    </div>
                </div>

                <div class="menu-step" id="menu-academy">
                    <div class="academy-container">
                        <div class="academy-hero">
                            <h1 class="academy-title">Academia de Campeones</h1>
                            <p>Convierte tu pasi√≥n en maestr√≠a. De principiante a Gran Maestro.</p>
                            <div id="academy-auth-notice" style="margin-top:20px; color:var(--warning); display:none;">
                                ‚ö†Ô∏è Acceso exclusivo para usuarios registrados.
                            </div>
                        </div>

                        <div class="academy-msg-box" id="academy-placement-box" style="display:none;">
                            <h3>üéØ ¬øNo sabes por d√≥nde empezar?</h3>
                            <p>Haz nuestra prueba de nivel para saltar las lecciones que ya conoces.</p>
                            <button class="btn-hero-primary" style="margin-top:10px; padding:10px 20px;"
                                onclick="startPlacementTest()">Hacer Prueba de Nivel</button>
                        </div>

                        <div id="academy-lessons-grid" class="academy-grid">
                            <!-- Inyectado por JS -->
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-estudio">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Estudio y Teor√≠a de Aperturas</h3>
                    </div>
                    <div class="grid-menu" style="grid-template-columns: 1fr;"> <!-- Una sola columna para centrar -->
                        <div class="card-option" onclick="showSubMenu('aperturas')">
                            <span class="opt-icon">üìã</span>
                            <h4>M√≥dulo de Aperturas</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Aprende y practica tus l√≠neas favoritas</p>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-analisis">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Herramientas de An√°lisis</h3>
                    </div>
                    <div class="grid-menu">
                        <div class="card-option" onclick="setMode('study')">
                            <span class="opt-icon">üîç</span>
                            <h4>An√°lisis Libre</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Explora posiciones con el motor</p>
                        </div>
                        <div class="card-option" onclick="showBoardEditor()">
                            <span class="opt-icon">‚úèÔ∏è</span>
                            <h4>Editor de Tablero</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Configura posiciones, FEN y PGN</p>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-aperturas">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="showSubMenu('estudio')">‚Üê</button>
                        <h3 class="menu-title">M√≥dulo de Aperturas</h3>
                    </div>

                    <div class="opening-selection-container"
                        style="padding:15px; display:flex; flex-direction:column; gap:15px;">
                        <div class="sel-group">
                            <label
                                style="font-size:0.6rem; color:var(--accent); font-weight:800; display:block; margin-bottom:8px;">1.
                                SELECCIONAR APERTURA O DEFENSA</label>
                            <select id="opening-module-sel" class="custom-select"
                                style="width:100% !important; padding:12px;">
                                <option value="">-- Buscar Apertura... --</option>
                            </select>
                        </div>

                        <!-- Color Toggle for Training -->
                        <div class="sel-group"
                            style="display:flex; justify-content:space-between; align-items:center; background:rgba(255,255,255,0.05); padding:10px; border-radius:8px;">
                            <label style="font-size:0.7rem; color:var(--text-dim); margin-bottom:0;">JUGAR CON:</label>
                            <div class="pill-toggle">
                                <span class="pill-opt active" id="pill-w"
                                    onclick="toggleOpeningColor('w')">Blancas</span>
                                <span class="pill-opt" id="pill-b" onclick="toggleOpeningColor('b')">Negras</span>
                            </div>
                        </div>

                        <div class="sel-group"
                            style="padding-top:10px; border-top:1px solid rgba(255,255,255,0.05); display:none;">
                            <label
                                style="font-size:0.6rem; color:var(--trap-color); font-weight:800; display:block; margin-bottom:8px;">2.
                                TRAMPAS Y MATES T√çPICOS</label>
                            <select id="opening-traps-sel" class="custom-select"
                                style="width:100% !important; padding:12px; border-color:rgba(239,68,68,0.3);">
                                <option value="">-- Elige una trampa o mate... --</option>
                            </select>
                        </div>
                    </div>

                    <div class="grid-menu">
                        <div class="card-option" onclick="startOpeningModule('theory')">
                            <span class="opt-icon">üìñ</span>
                            <h4>1. Teor√≠a</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Movimientos, celadas y planes</p>
                        </div>
                        <div class="card-option" onclick="startOpeningModule('training')">
                            <span class="opt-icon">üéØ</span>
                            <h4>2. Entrenamiento</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Pr√°ctica vs IA (Sigue la l√≠nea)</p>
                        </div>
                        <div class="card-option" onclick="startOpeningModule('exercises')">
                            <span class="opt-icon">üß©</span>
                            <h4>3. Ejercicios</h4>
                            <p style="font-size:0.6rem; opacity:0.6;">Situaciones t√≠picas y t√°cticas</p>
                        </div>
                    </div>
                </div>

                <div class="menu-step" id="menu-puzzles">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Entrenar T√°cticas</h3>
                    </div>
                    <!-- Configuraci√≥n de Puzzles (Restaurada a formato simple) -->
                    <!-- Configuraci√≥n de Puzzles (Grid Directo) -->
                    <div class="puzzles-config" style="margin-top: 20px;">
                        <label
                            style="font-size: 0.7rem; color: var(--text-dim); font-weight: 800; display: block; margin-bottom: 15px;">
                            SELECCIONA TIPO DE ENTRENAMIENTO
                        </label>

                        <div class="grid-menu" id="puz-grid-options">
                            <div class="card-option" onclick="selectPuzzleCategory('all')">
                                <span class="opt-icon">üé≤</span>
                                <h4>Mezclado</h4>
                                <p style="font-size:0.6rem; opacity:0.6;">Dificultad progresiva</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('mate')">
                                <span class="opt-icon">üèÅ</span>
                                <h4>Mate</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">Dar el golpe final</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('fork')">
                                <span class="opt-icon">üç¥</span>
                                <h4>Doble</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">Ataque doble</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('pin')">
                                <span class="opt-icon">üìå</span>
                                <h4>Clavada</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">Pieza inm√≥vil</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('hangingPiece')">
                                <span class="opt-icon">üçé</span>
                                <h4>Colgada</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">Piezas indefensas</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('discoveredAttack')">
                                <span class="opt-icon">üéÅ</span>
                                <h4>Descubierta</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">Ataque oculto</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('opening')">
                                <span class="opt-icon">üìñ</span>
                                <h4>Apertura</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">Errores iniciales</p>
                            </div>
                            <div class="card-option category-card" onclick="selectPuzzleCategory('endgame')">
                                <span class="opt-icon">‚è≥</span>
                                <h4>Final</h4>
                                <p style="font-size:0.5rem; opacity:0.6;">T√©cnica √∫ltima</p>
                            </div>
                        </div>

                        <!-- Hidden select for compatibility logic -->
                        <select id="puz-cat-sel" style="display:none;">
                            <option value="all">all</option>
                            <option value="mate">mate</option>
                            <option value="fork">fork</option>
                            <option value="pin">pin</option>
                            <option value="sacrifice">sacrifice</option>
                            <option value="opening">opening</option>
                            <option value="middlegame">middlegame</option>
                            <option value="endgame">endgame</option>
                            <option value="hangingPiece">hangingPiece</option>
                            <option value="discoveredAttack">discoveredAttack</option>
                            <option value="kingsideAttack">kingsideAttack</option>
                            <option value="doubleCheck">doubleCheck</option>
                        </select>
                    </div>

                    <!-- Puzzles Statistics & History -->
                    <div class="puzzles-stats-container">
                        <div class="puz-stats-header">
                            <span>üìä TUS ESTAD√çSTICAS</span>
                            <span id="puz-elo-display" style="color:var(--accent); font-weight:800;">500üß©</span>
                        </div>
                        <div id="puz-stats-list" class="puz-stats-grid">
                            <!-- Themes stats will be injected here -->
                        </div>

                        <div class="puz-history-header">üïí √öLTIMOS ACERTADOS</div>
                        <div id="puz-history-list" class="puz-history-list">
                            <!-- History items will be injected here -->
                        </div>
                    </div>
                </div>

                <!-- NUEVO: MEN√ö DE HISTORIAL Y ESTAD√çSTICAS -->
                <div class="menu-step" id="menu-historial">
                    <div class="menu-header-mobile">
                        <button class="btn-back-arrow" onclick="goBackToMenu()">‚Üê</button>
                        <h3 class="menu-title">Historial y Estad√≠sticas</h3>
                    </div>

                    <!-- Historial de Partidas -->
                    <div style="padding: 20px;">
                        <h3 style="font-size:1.2rem; margin-bottom:15px; color:var(--accent);">‚ôüÔ∏è Historial de Partidas
                        </h3>
                        <div id="game-history-container"
                            style="background:var(--bg-panel); border-radius:12px; padding:15px; border:1px solid var(--border); min-height:200px;">
                            <div style="text-align:center; color:var(--text-dim); padding:40px 20px;">
                                <p>üìã Aqu√≠ aparecer√° el historial de tus partidas</p>
                                <p style="font-size:0.8rem; margin-top:10px;">Juega algunas partidas para ver tu
                                    progreso</p>
                            </div>
                        </div>

                        <!-- Estad√≠sticas de Puzzles -->
                        <h3 style="font-size:1.2rem; margin:25px 0 15px; color:var(--accent);">üß© Estad√≠sticas de
                            T√°cticas</h3>
                        <div class="puzzles-stats-container">
                            <div class="puz-stats-header">
                                <span>üìä TUS ESTAD√çSTICAS</span>
                                <span id="puz-elo-display-main"
                                    style="color:var(--accent); font-weight:800;">500üß©</span>
                            </div>
                            <div id="puz-stats-list-main" class="puz-stats-grid">
                                <!-- Themes stats will be injected here -->
                            </div>

                            <div class="puz-history-header">üïí √öLTIMOS ACERTADOS</div>
                            <div id="puz-history-list-main" class="puz-history-list">
                                <!-- History items will be injected here -->
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <div id="board-layout" class="board-wrapper">
                <!-- Mobile Move Quality Timeline -->
                <div class="mobile-move-timeline" id="mobile-move-timeline">
                    <!-- Moves will be added here dynamically -->
                </div>


                <div class="player-top">
                    <div class="user-meta">
                        <span id="opp-avatar" class="avatar-circle">üë§</span>
                        <span id="opp-name">Oponente</span>
                    </div>
                    <div id="opp-timer" class="timer-display">10:00</div>
                </div>

                <div class="board-container">
                    <div class="eval-bar-vertical">
                        <div id="eval-fill-master" class="eval-fill"></div>
                    </div>
                    <div class="board-relative">
                        <div id="myBoard"></div>
                        <canvas id="arrowCanvas"></canvas>

                        <div id="game-overlay">
                            <h2 id="overlay-msg">JAQUE MATE</h2>
                            <button onclick="$('#game-overlay').fadeOut()" class="btn-close">Continuar</button>
                        </div>
                    </div>
                </div>

                <div class="player-bottom">
                    <div class="user-meta">
                        <span id="my-avatar" class="avatar-circle active">üë§</span>
                        <span id="my-name-display">Invitado</span>
                    </div>
                    <div id="my-timer" class="timer-display">10:00</div>
                </div>

                <div class="nav-controls">
                    <button class="ctrl-btn mobile-only-btn" id="btn-mobile-back" onclick="goBackToMenu()">üè†</button>
                    <button class="ctrl-btn" id="btn-nav-first">‚èÆ</button>
                    <button class="ctrl-btn" id="btn-nav-prev">‚óÄ</button>
                    <button class="ctrl-btn" id="btn-nav-next">‚ñ∂</button>
                    <button class="ctrl-btn" id="btn-nav-last">‚è≠</button>
                    <button class="ctrl-btn" id="btn-flip">üîÑ</button>
                </div>

                <!-- CONTROLES DE PUZZLE (REUBICADOS BAJO EL TABLERO) -->
                <div id="puzzle-controls" class="puzzle-controls" style="display:none; margin-top: 15px;">
                    <div class="puz-info-row" style="margin-bottom:10px;">
                        <div id="puz-desc-main" class="puz-description-main">Cargando puzzle...</div>
                        <div id="puz-timer-main" class="puz-timer-main" style="margin-left:auto;">00:00</div>
                    </div>
                    <div class="puz-actions-row">
                        <button class="btn-puzzle-action" onclick="showPuzzleHint()" aria-label="Pista">
                            <span class="icon" aria-hidden="true">üí°</span> Pista
                        </button>
                        <button class="btn-puzzle-action danger" onclick="showPuzzleSolution()" aria-label="Soluci√≥n">
                            <span class="icon" aria-hidden="true">üîì</span> Soluci√≥n
                        </button>
                        <button class="btn-puzzle-action primary" onclick="loadRandomPuzzle()"
                            aria-label="Siguiente puzzle">
                            Siguiente <span class="icon" aria-hidden="true">‚ûî</span>
                        </button>
                    </div>
                </div>
            </div>
        </main>

        <!-- Mobile Side Tabs -->
        <div class="mobile-side-tab mobile-tab-right">
            <div class="tab-icon">üìä</div>
            <div class="tab-label">INFO</div>
        </div>

        <!-- Mobile Info Modal -->
        <div id="mobile-info-modal" class="mobile-info-modal">
            <div class="mobile-info-header">
                <h3 id="mobile-modal-title">Informaci√≥n de Partida</h3>
                <button class="mobile-close-btn" onclick="closeMobileInfo()">‚úï</button>
            </div>
            <div class="mobile-info-content">
                <!-- TACTICS STATS SECTION (Visible only in Tactics Mode) -->
                <div id="mobile-tactics-stats" style="display:none;">
                    <div style="text-align:center; padding:20px 0;">
                        <h1 id="mobile-tactics-elo" style="font-size:3em; color:var(--accent); margin:0;">1240</h1>
                        <span
                            style="font-size:0.9em; color:var(--text-dim); letter-spacing:1px; text-transform:uppercase;">Rating
                            T√°ctico</span>
                    </div>
                    <div id="puz-feedback-mobile" style="text-align:center; margin-bottom:15px;"></div>
                    <div class="stats-bars-container"></div>
                </div>

                <!-- Analysis Section -->
                <div class="panel-section collapsible-panel game-info-only">
                    <div class="panel-header clickable" onclick="togglePanelSection('mobile-analysis-content')">
                        <h3>üìä An√°lisis en Tiempo Real</h3>
                        <span class="collapse-arrow">‚ñº</span>
                    </div>
                    <div id="mobile-analysis-content" class="panel-content">
                        <div class="eval-bar-horizontal">
                            <div id="mobile-eval-fill" class="eval-fill-h"></div>
                            <span id="mobile-eval-text">0.0</span>
                        </div>
                        <div class="eval-stats-grid">
                            <div class="eval-stat">
                                <span class="stat-label">Precisi√≥n</span>
                                <span class="stat-value" id="mobile-accuracy">--</span>
                            </div>
                            <div class="eval-stat">
                                <span class="stat-label">Profundidad</span>
                                <span class="stat-value" id="mobile-depth">18</span>
                            </div>
                        </div>
                        <div class="eval-graph-container"
                            style="margin-top:10px; background:#000; border-radius:8px; height:80px; position:relative; overflow:hidden; border:1px solid var(--border);">
                            <canvas id="evalChartMobile" style="width:100%; height:100%;"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Best Moves Section -->
                <div class="panel-section collapsible-panel">
                    <div class="panel-header clickable" onclick="togglePanelSection('mobile-moves-content')">
                        <h3>üéØ Mejores Jugadas</h3>
                        <div style="display:flex; align-items:center; gap:10px;">
                            <label class="toggle-switch-small" onclick="event.stopPropagation();">
                                <input type="checkbox" id="mobile-toggle-best-moves" checked
                                    onchange="toggleBestMoves(this.checked)">
                                <span class="slider-small"></span>
                            </label>
                            <span class="collapse-arrow">‚ñº</span>
                        </div>
                    </div>
                    <div id="mobile-moves-content" class="panel-content">
                        <div id="mobile-best-moves" class="moves-list"></div>
                    </div>
                </div>

                <!-- Opening/Maestro Section -->
                <div class="panel-section collapsible-panel">
                    <div class="panel-header clickable" onclick="togglePanelSection('mobile-maestro-content')">
                        <h3>üí° Perspectiva del Maestro</h3>
                        <span class="collapse-arrow">‚ñº</span>
                    </div>
                    <div id="mobile-maestro-content" class="panel-content">
                        <div class="maestro-insight-card">
                            <div class="insight-group">
                                <span class="insight-label">üìä APERTURA:</span>
                                <div id="mobile-maestro-opening" class="insight-val">Analizando...</div>
                            </div>
                            <div class="insight-group">
                                <span class="insight-label">üß† PLAN:</span>
                                <div id="mobile-maestro-plan" class="insight-val">--</div>
                            </div>
                            <div id="mobile-maestro-trap-box" class="insight-group trap-alert" style="display:none;">
                                <span class="insight-label">üö® ALERTA:</span>
                                <div id="mobile-maestro-trap" class="insight-val warning-text"></div>
                            </div>
                            <div id="mobile-maestro-stats-container" class="insight-group"
                                style="display:none; margin-top:5px;">
                                <span class="insight-label">ESTAD√çSTICAS GLOBALES</span>
                                <div class="stats-bar"
                                    style="display:flex; height:12px; border-radius:4px; overflow:hidden; margin-top:5px; width:100%;">
                                    <div id="mobile-stat-white" style="background:#fff; width:33%;"></div>
                                    <div id="mobile-stat-draw" style="background:#777; width:33%;"></div>
                                    <div id="mobile-stat-black" style="background:#222; width:34%;"></div>
                                </div>
                                <div
                                    style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--text-dim); margin-top:2px;">
                                    <span id="mobile-txt-white">W: --%</span>
                                    <span id="mobile-txt-draw">D: --%</span>
                                    <span id="mobile-txt-black">B: --%</span>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Coach Logs Section -->
                <div class="panel-section collapsible-panel game-info-only">
                    <div class="panel-header clickable" onclick="togglePanelSection('mobile-logs-content')">
                        <h3>üí¨ Comentarios del Maestro</h3>
                        <span class="collapse-arrow">‚ñº</span>
                    </div>
                    <div id="mobile-logs-content" class="panel-content">
                        <div id="mobile-coach-logs" class="coach-stable-container"></div>
                    </div>
                </div>

                <!-- Threats Section Mobile -->
                <div id="mobile-threats-section" class="panel-section threats-panel"
                    style="display:none; border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.05); margin-top:10px;">
                    <div class="panel-header">
                        <h4 style="color:#ef4444; margin:0;">üö® Amenazas</h4>
                    </div>
                    <div id="mobile-threats-list" style="padding:10px; font-size:0.8rem; font-weight:600;"></div>
                </div>
            </div>

        </div>

        <!-- PANEL LATERAL (DERECHA) - REDISE√ëADO CON SECCIONES COLAPSABLES -->
        <aside class="side-panel">
            <!-- SECCI√ìN T√ÅCTICAS (Solo visible en modo ejercicios) -->
            <section id="sec-exercises" class="mode-section">
                <div class="section-header">
                    <h3>üß© Modo T√°ctico</h3>
                </div>

                <!-- Contenedor de Feedback de Puzzle -->
                <div id="puzzle-feedback-panel"
                    style="min-height: 80px; margin-bottom: 15px; padding: 12px; border-radius: 8px; background: rgba(0,0,0,0.2); border: 1px solid var(--border); display: none;">
                    <div id="puzzle-feedback-content" style="text-align: center; font-size: 0.9rem; font-weight: 600;">
                    </div>
                </div>

                <div id="tactic-dashboard-container" style="padding:15px;">
                    <div style="font-size:0.75rem; color:var(--text-dim); text-align:center; padding:20px;">
                        Cargando estad√≠sticas de entrenamiento...
                    </div>
                </div>
            </section>

            <!-- 1. PERSPECTIVA DEL MAESTRO (Colapsable) -->
            <div class="panel-section collapsible-panel">
                <div class="panel-header clickable" onclick="togglePanelSection('maestro-content')">
                    <h3>üí° Perspectiva del Maestro</h3>
                    <span class="collapse-arrow">‚ñº</span>
                </div>
                <div id="maestro-content" class="panel-content">
                    <div class="maestro-insight-card">
                        <div class="insight-group">
                            <span class="insight-label">üìä APERTURA:</span>
                            <div id="maestro-opening-name" class="insight-val">Analizando...</div>
                        </div>
                        <div class="insight-group">
                            <span class="insight-label">üß† PLAN:</span>
                            <div id="maestro-plan" class="insight-val">Desarrollando estructura...</div>
                        </div>
                        <div class="insight-group trap-alert" id="maestro-trap-container" style="display:none;">
                            <span class="insight-label">üö® ALERTA:</span>
                            <div id="maestro-trap" class="insight-val warning-text">Ninguna amenaza detectada.</div>
                        </div>
                        <div class="insight-group" id="maestro-stats-container" style="display:none; margin-top:5px;">
                            <span class="insight-label">ESTAD√çSTICAS GLOBALES (LICHESS)</span>
                            <div class="stats-bar"
                                style="display:flex; height:12px; border-radius:4px; overflow:hidden; margin-top:5px; width:100%;">
                                <div id="stat-white" style="background:#fff; width:33%;"></div>
                                <div id="stat-draw" style="background:#777; width:33%;"></div>
                                <div id="stat-black" style="background:#222; width:34%;"></div>
                            </div>
                            <div
                                style="display:flex; justify-content:space-between; font-size:0.6rem; color:var(--text-dim); margin-top:2px;">
                                <span id="txt-white">W: --%</span>
                                <span id="txt-draw">D: --%</span>
                                <span id="txt-black">B: --%</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- 2. HISTORIAL DE PARTIDA (Desktop) -->
            <div class="panel-section collapsible-panel desktop-only-panel">
                <div class="panel-header clickable" onclick="togglePanelSection('history-content-desktop')">
                    <h3>üìú Historial de Partida</h3>
                    <span class="collapse-arrow">‚ñº</span>
                </div>
                <div id="history-content-desktop" class="panel-content">
                    <div id="desktop-move-log" class="desktop-move-log">
                        <!-- Moves will be shown here as well -->
                        <div style="font-size:0.75rem; color:var(--text-muted); text-align:center; padding:10px;">
                            Sin movimientos.
                        </div>
                    </div>
                </div>
            </div>

            <!-- 3. AN√ÅLISIS EN TIEMPO REAL (Colapsable) -->
            <div class="panel-section collapsible-panel">
                <div class="panel-header clickable" onclick="togglePanelSection('analysis-content')">
                    <h3>üìä An√°lisis en Tiempo Real</h3>
                    <span class="collapse-arrow">‚ñº</span>
                </div>
                <div id="analysis-content" class="panel-content">
                    <div class="eval-bar-horizontal">
                        <div id="eval-bar-fill" class="eval-fill-h"></div>
                        <span id="eval-text-overlay">0.0</span>
                    </div>
                    <div class="eval-stats-grid">
                        <div class="eval-stat">
                            <span class="stat-label">Precisi√≥n</span>
                            <span class="stat-value" id="eval-accuracy">--</span>
                        </div>
                        <div class="eval-stat">
                            <span class="stat-label">Profundidad</span>
                            <span class="stat-value" id="eval-depth">18</span>
                        </div>
                    </div>
                    <div class="eval-graph-container"
                        style="margin-top:15px; background:#000; border-radius:8px; height:80px; position:relative; overflow:hidden; border:1px solid var(--border);">
                        <canvas id="evalChart" style="width:100%; height:100%;"></canvas>
                    </div>
                </div>
            </div>

            <!-- 3. MEJORES JUGADAS (Colapsable) -->
            <div class="panel-section collapsible-panel">
                <div class="panel-header clickable" onclick="togglePanelSection('moves-content')">
                    <h3>üéØ Mejores Jugadas</h3>
                    <div style="display:flex; align-items:center; gap:10px;">
                        <label class="toggle-switch-small" onclick="event.stopPropagation();">
                            <input type="checkbox" id="toggle-best-moves-main" checked
                                onchange="toggleBestMoves(this.checked)">
                            <span class="slider-small"></span>
                        </label>
                        <span class="collapse-arrow">‚ñº</span>
                    </div>
                </div>
                <div id="moves-content" class="panel-content">
                    <div id="best-moves-list" class="moves-list">
                        <div class="move-item placeholder">Calculando l√≠neas...</div>
                    </div>
                </div>
            </div>

            <!-- 4. LOGS DEL MAESTRO (Colapsable) -->
            <div class="panel-section collapsible-panel">
                <div class="panel-header clickable" onclick="togglePanelSection('logs-content')">
                    <h3>üí¨ Comentarios del Maestro</h3>
                    <span class="collapse-arrow">‚ñº</span>
                </div>
                <div id="logs-content" class="panel-content">
                    <div id="coach-txt" class="coach-stable-container">
                        <div style="font-size:0.75rem; color:var(--text-muted); text-align:center; padding:20px;">
                            Posici√≥n inicial. Realiza un movimiento para ver el an√°lisis del Maestro.
                        </div>
                    </div>
                </div>
            </div>

            <!-- Amenazas (Oculto por defecto) -->
            <div class="panel-section threats-panel" id="threats-panel"
                style="display:none; border-left: 4px solid #ef4444; background: rgba(239, 68, 68, 0.05);">
                <div class="panel-header">
                    <h3 style="color:#ef4444;">üö® Amenazas Detectadas</h3>
                </div>
                <div id="threats-list" style="padding:10px; font-size:0.8rem; font-weight:600;">
                    Ninguna amenaza inmediata.
                </div>
            </div>
        </aside>
    </div>

    <!-- MODALES AUTH -->
    <div class="modal-overlay" id="auth-modal">
        <div class="modal-card">
            <div class="auth-tabs">
                <button class="auth-tab-btn active" onclick="switchAuthMode('login')">INICIAR SESI√ìN</button>
                <button class="auth-tab-btn" onclick="switchAuthMode('register')">REGISTRARSE</button>
            </div>

            <div id="auth-form-content">
                <div class="input-group">
                    <label>USUARIO</label>
                    <div class="input-container">
                        <input type="text" id="auth-user" placeholder="Tu nombre de usuario">
                    </div>
                </div>

                <div class="input-group" id="group-email" style="display:none;">
                    <label>EMAIL</label>
                    <div class="input-container">
                        <input type="email" id="auth-email" placeholder="ejemplo@email.com">
                    </div>
                </div>

                <div class="input-group">
                    <label>CONTRASE√ëA</label>
                    <div class="input-container">
                        <input type="password" id="auth-pass" placeholder="******">
                        <span class="password-toggle" onclick="togglePasswordVisibility('auth-pass')">üëÅÔ∏è</span>
                    </div>
                </div>

                <div class="remember-me-container" id="remember-me-row">
                    <label style="display:flex; align-items:center; gap:8px; cursor:pointer;">
                        <input type="checkbox" id="auth-remember">
                        Recordarme
                    </label>
                </div>
            </div>

            <button class="btn-primary-auth" id="btn-auth-submit">ENTRAR</button>
            <button class="btn-secondary" onclick="$('#auth-modal').fadeOut()">CANCELAR</button>
        </div>
    </div>

    <!-- Toast Container for Notifications -->
    <!-- Duplicate toast-container removed -->

    <!-- MODAL PRUEBA DE NIVEL -->
    <div id="placement-modal" class="placement-modal">
        <div class="placement-card">
            <div id="placement-content">
                <!-- Inyectado por JS -->
            </div>
        </div>
    </div>

    <script src="academy_data.js"></script>
    <script src="ai_module.js"></script>
    <script src="client.js?v=2"></script>
    <!-- MODAL DE INFORME DE PARTIDA -->
    <div id="game-report-modal" class="modal-overlay">
        <div class="modal-card report-card">
            <h2 style="text-align:center; color:var(--accent); margin-bottom:10px;">Resumen de Partida</h2>
            <div class="report-main-stats">
                <div class="report-stat-big">
                    <span id="report-accuracy">0%</span>
                    <label>PRECISI√ìN</label>
                </div>
            </div>
            <div id="report-move-breakdown" class="report-breakdown">
                <!-- Se llena din√°micamente -->
            </div>
            <div class="report-actions">
                <button class="btn-primary-auth" onclick="$('#game-report-modal').fadeOut()">Cerrar</button>
                <button class="btn-secondary" onclick="exportPGN()">Exportar PGN</button>
            </div>
        </div>
    </div>

    <!-- AUDIO PARA TTS (HIDDEN) -->
    <div id="tts-anchor"></div>

    <!-- MODAL EDITOR DE TABLERO -->
    <div id="board-editor-modal" class="modal-overlay">
        <div class="modal-card" style="max-width: 500px;">
            <h2 style="text-align:center; color:var(--accent); margin-bottom:15px;">Editor de Posici√≥n</h2>

            <label
                style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:5px;">IMPORTAR
                FEN</label>
            <div class="input-container" style="margin-bottom:15px;">
                <input type="text" id="editor-fen-input"
                    placeholder="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR w KQkq - 0 1">
            </div>

            <label
                style="font-size:0.7rem; color:var(--text-dim); font-weight:800; display:block; margin-bottom:5px;">IMPORTAR
                PGN</label>
            <div class="input-container" style="margin-bottom:15px;">
                <textarea id="editor-pgn-input" rows="4" placeholder="1. e4 e5 2. Nf3..."
                    style="resize:none; background:transparent; color:white; width:100%; border:none; outline:none; font-family:inherit;"></textarea>
            </div>

            <div class="editor-actions"
                style="display:grid; grid-template-columns: 1fr 1fr; gap:10px; margin-bottom:15px;">
                <button class="btn-secondary" onclick="loadEditorPosition('start')">Posici√≥n Inicial</button>
                <button class="btn-secondary" onclick="loadEditorPosition('clear')">Limpiar Tablero</button>
            </div>

            <button class="btn-primary-auth" onclick="applyEditorPosition()">ANALIZAR ESTA POSICI√ìN</button>
            <button class="btn-secondary" style="width:100%; margin-top:8px;"
                onclick="$('#board-editor-modal').fadeOut()">CANCELAR</button>
        </div>
    </div>
</body>

</html>